
// === FOLDER: lib (DEEP) ===

// --- FILE: lib/app.dart ---
import 'package:fintracker/bloc/cubit/app_cubit.dart';
import 'package:fintracker/screens/main.screen.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_localizations/flutter_localizations.dart';

class App extends StatelessWidget {
  const App({super.key});
  @override
  Widget build(BuildContext context) {
    SystemChrome.setSystemUIOverlayStyle(SystemUiOverlayStyle(
        statusBarColor: Colors.transparent,
        statusBarIconBrightness: MediaQuery.of(context).platformBrightness
    ));
    return  BlocBuilder<AppCubit, AppState>(
        builder: (context, state){
          return MaterialApp(
            title: 'Fintracker',
            theme: ThemeData(
                useMaterial3: true,
                brightness: MediaQuery.of(context).platformBrightness,
                navigationBarTheme: NavigationBarThemeData(
                  labelTextStyle: WidgetStateProperty.resolveWith((Set<WidgetState> states){
                    TextStyle style =  const TextStyle(fontWeight: FontWeight.w500, fontSize: 11);
                    if(states.contains(WidgetState.selected)){
                      style = style.merge(const TextStyle(fontWeight: FontWeight.w600));
                    }
                    return style;
                  }),
                )
            ),
            home: const MainScreen(),
            localizationsDelegates: const [
              GlobalWidgetsLocalizations.delegate,
              GlobalMaterialLocalizations.delegate,
            ],
          );
        }
    );
  }
}

// --- FILE: lib/bloc/cubit/app_cubit.dart ---
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:shared_preferences/shared_preferences.dart';

class AppState{
  late String? username;
  late int themeColor;
  late String? currency;

  static Future<AppState> getState() async {
    final SharedPreferences prefs = await SharedPreferences.getInstance();
    int? themeColor = prefs.getInt("themeColor");
    String? username = prefs.getString("username");
    String? currency = prefs.getString("currency");

    AppState appState = AppState();
    appState.themeColor = themeColor ?? Colors.green.value;
    appState.username = username;
    appState.currency = currency;

    return appState;
  }
}
class AppCubit extends Cubit<AppState>{
  AppCubit(AppState initialState) : super(initialState);

  Future<void> updateUsername(username) async {
    final SharedPreferences prefs = await SharedPreferences.getInstance();
    await prefs.setString("username", username);
    emit(await AppState.getState());
  }

  Future<void> updateCurrency(currency) async {
    final SharedPreferences prefs = await SharedPreferences.getInstance();
    await prefs.setString("currency", currency);
    emit(await AppState.getState());
  }
  Future<void> updateThemeColor(int color) async {
    final SharedPreferences prefs = await SharedPreferences.getInstance();
    await prefs.setInt("themeColor", color);
    emit(await AppState.getState());
  }

  Future<void> reset() async {
    final SharedPreferences prefs = await SharedPreferences.getInstance();
    await prefs.remove("currency");
    await prefs.remove("themeColor");
    await prefs.remove("username");
    emit(await AppState.getState());
  }

}

// --- FILE: lib/dao/account_dao.dart ---
import 'dart:async';
import 'package:fintracker/helpers/db.helper.dart';
import 'package:fintracker/model/account.model.dart';
import 'package:sqflite/sqflite.dart';
class AccountDao {
  Future<int> create(Account account) async {
    final db = await getDBInstance();
    var result = await db.insert("accounts", account.toJson());
    return result;
  }

  Future<List<Account>> find({  bool withSummery=false}) async {
    final Database db = await getDBInstance();

    List<Map<String, dynamic>> result;
    if(withSummery){
      String fields = [
        "a.id","a.name","a.holderName","a.accountNumber","a.icon","a.color","a.isDefault",
        "SUM(CASE WHEN t.type='DR' AND t.account=a.id THEN t.amount END) as expense",
        "SUM(CASE WHEN t.type='CR' AND t.account=a.id THEN t.amount END) as income"
      ].join(",");
      String sql = "SELECT $fields FROM accounts a LEFT JOIN payments t ON t.account = a.id GROUP BY a.id";
      result = await db.rawQuery(sql);
    } else {
      result = await db.query("accounts",);
    }
    List<Account> accounts = [];
    if (result.isNotEmpty) {
      accounts = result.map((item) {
        Map<String, dynamic> nItem = Map.from(item);
        if(withSummery) {
          nItem["income"] = nItem["income"] ?? 0.0;
          nItem["expense"] = nItem["expense"]??0.0;
          nItem["balance"] = double.parse((nItem["income"] - nItem["expense"]).toString());
        }
        return Account.fromJson(nItem);
      }).toList();
    }
    return accounts;
  }

  Future<int> update(Account account) async {
    final db = await getDBInstance();
    var result = await db.update("accounts", account.toJson(), where: "id = ?", whereArgs: [account.id]);
    return result;
  }

  Future<int> upsert(Account account) async {
    if(account.id !=null) {
      return  await update(account);
    } else {
      return await create(account);
    }
  }



  Future<int> delete(int id) async {
    final db = await getDBInstance();
    var result = await db.delete("accounts", where: 'id = ?', whereArgs: [id]);
    await db.delete("payments", where: "account = ?", whereArgs:[id]);
    return result;
  }
}


// --- FILE: lib/dao/category_dao.dart ---
import 'dart:async';
import 'package:fintracker/helpers/db.helper.dart';
import 'package:fintracker/model/category.model.dart';
import 'package:intl/intl.dart';

class CategoryDao {
  Future<int> create(Category category) async {
    final db = await getDBInstance();
    var result = db.insert("categories", category.toJson());
    return result;
  }

  Future<List<Category>> find({ bool withSummery = true }) async {
    final db = await getDBInstance();

    List<Map<String, dynamic>> result;
    if(withSummery){
      String fields = [
        "c.id","c.name","c.icon","c.color", "c.budget",
        "SUM(CASE WHEN t.type='DR' AND t.category=c.id THEN t.amount END) as expense"
      ].join(",");
      DateTime from = DateTime(DateTime.now().year, DateTime.now().month,1,0,0);
      DateTime to = DateTime.now().add(const Duration(days: 1));
      DateFormat formatter = DateFormat("yyyy-MM-dd HH:mm");
      String sql = "SELECT $fields FROM categories c "
          "LEFT JOIN payments t ON t.category = c.id AND t.datetime BETWEEN DATE('${formatter.format(from)}') AND DATE('${formatter.format(to)}')"
          "GROUP BY c.id ";
      result = await db.rawQuery(sql);
    } else {
      result = await db.query("categories",);
    }
    List<Category> categories =[];
    if (result.isNotEmpty) {
      categories = result.map((item) => Category.fromJson(item)).toList();
    }
    return categories;
  }

  Future<int> update(Category category) async {
    final db = await getDBInstance();

    var result = await db.update("categories", category.toJson(), where: "id = ?", whereArgs: [category.id]);

    return result;
  }

  Future<int> upsert(Category category) {
    if(category.id !=null){
      return update(category);
    } else {
      return create(category);
    }
  }


  Future<int> delete(int id) async {
    final db = await getDBInstance();
    var result = await db.delete("categories", where: 'id = ?', whereArgs: [id]);
    return result;
  }

  Future deleteAll() async {
    final db = await getDBInstance();
    var result = await db.delete(
      "categories",
    );
    return result;
  }
}

// --- FILE: lib/dao/payment_dao.dart ---
import 'dart:async';
import 'package:fintracker/dao/account_dao.dart';
import 'package:fintracker/dao/category_dao.dart';
import 'package:fintracker/helpers/db.helper.dart';
import 'package:fintracker/model/account.model.dart';
import 'package:fintracker/model/category.model.dart';
import 'package:fintracker/model/payment.model.dart';
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';


class PaymentDao {
  Future<int> create(Payment payment) async {
    final db = await getDBInstance();
    var result = db.insert("payments", payment.toJson());
    return result;
  }

  Future<List<Payment>> find({
    DateTimeRange? range,
    PaymentType? type,
    Category? category,
    Account? account
}) async {
    final db = await getDBInstance();
    String where = "";

    if(range!=null){
      where += "AND datetime BETWEEN DATE('${DateFormat('yyyy-MM-dd kk:mm:ss').format(range.start)}') AND DATE('${DateFormat('yyyy-MM-dd kk:mm:ss').format(range.end.add(const Duration(days: 1)))}')";
    }

    //type check
    if(type != null){
      where += "AND type='${type == PaymentType.credit?"DR":"CR"}' ";
    }

    //icon check
    if(account != null){
      where += "AND account='${account.id}' ";
    }

    //icon check
    if(category != null){
      where += "AND category='${category.id}' ";
    }

    //categories
    List<Category> categories = await CategoryDao().find();
    List<Account> accounts = await AccountDao().find();


    List<Payment> payments = [];
    List<Map<String, Object?>> rows =  await db.query(
        "payments",
        orderBy: "datetime DESC, id DESC",
        where: "1=1 $where"
    );
    for (var row in rows) {
      Map<String, dynamic> payment = Map<String, dynamic>.from(row);
      Account account = accounts.firstWhere((a) => a.id == payment["account"]);
      Category category = categories.firstWhere((c) => c.id == payment["category"]);
      payment["category"] = category.toJson();
      payment["account"] = account.toJson();
      payments.add(Payment.fromJson(payment));
    }

    return payments;
  }

  Future<int> update(Payment payment) async {
    final db = await getDBInstance();

    var result = await db.update("payments", payment.toJson(), where: "id = ?", whereArgs: [payment.id]);

    return result;
  }

  Future<int> upsert(Payment payment) async {
    final db = await getDBInstance();
    int result;
    if(payment.id != null) {
      result = await db.update(
          "payments", payment.toJson(), where: "id = ?",
          whereArgs: [payment.id]);
    } else {
      result = await db.insert("payments", payment.toJson());
    }

    return result;
  }


  Future<int> deleteTransaction(int id) async {
    final db = await getDBInstance();
    var result = await db.delete("payments", where: 'id = ?', whereArgs: [id]);
    return result;
  }

  Future deleteAllTransactions() async {
    final db = await getDBInstance();
    var result = await db.delete(
      "payments",
    );
    return result;
  }
}

// --- FILE: lib/data/icons.dart ---
import 'package:flutter/material.dart';

class AppIcons {
  static final List<IconData> icons = [
    Icons.wallet,
    Icons.money,
    Icons.account_balance,
    Icons.shopping_bag,
    Icons.fastfood,
    Icons.handshake,
    Icons.public,
    Icons.thumb_up,
    Icons.face,
    Icons.rocket_launch,
    Icons.eco,
    Icons.pets,
    Icons.emoji_objects,
    Icons.health_and_safety,
    Icons.monitor_heart,
    Icons.gavel,
    Icons.diversity_3,
    Icons.workspaces,
    Icons.cookie,
    Icons.emoji_flags,
    Icons.hive,
    Icons.heart_broken,
    Icons.medication_liquid,
    Icons.shopping_cart,
    Icons.landscape,
    Icons.medication,
    Icons.verified,
    Icons.lock,
    Icons.celebration,
    Icons.stars,
    Icons.developer_mode,
    Icons.person,
    Icons.bar_chart,
    Icons.domain,
    Icons.leaderboard,
    Icons.work,
    Icons.credit_card,
    Icons.loyalty,
    Icons.card_membership,
    Icons.pallet,
    Icons.restaurant,
    Icons.restaurant_menu,
    Icons.join_full,
  ];
}

// --- FILE: lib/events.dart ---
import 'package:events_emitter/emitters/event_emitter.dart';
enum GlobalEventTypes{
  paymentUpdate,
  categoryUpdate,
  accountUpdate
}
final globalEvent = EventEmitter();

// --- FILE: lib/helpers/color.helper.dart ---
import 'package:flutter/material.dart';

class ColorHelper{
  static Color darken(Color color, [double amount = .1]) {
    assert(amount >= 0 && amount <= 1);

    final hsl = HSLColor.fromColor(color);
    final hslDark = hsl.withLightness((hsl.lightness - amount).clamp(0.0, 1.0));

    return hslDark.toColor();
  }

  static Color lighten(Color color, [double amount = .1]) {
    assert(amount >= 0 && amount <= 1);

    final hsl = HSLColor.fromColor(color);
    final hslLight = hsl.withLightness((hsl.lightness + amount).clamp(0.0, 1.0));

    return hslLight.toColor();
  }
}

// --- FILE: lib/helpers/currency.helper.dart ---
import 'package:intl/intl.dart';

class CurrencyHelper {
  static String format(
      double amount, {
        String? symbol = "₹",
        String? name = "INR",
        String? locale = "en_IN",
      }) {
    return NumberFormat('$symbol##,##,##,###.####', locale).format(amount);
  }
}



// --- FILE: lib/helpers/db.helper.dart ---

import "dart:convert";
import "dart:io";
import "package:flutter/material.dart";
// ignore: depend_on_referenced_packages
import "package:path/path.dart";
import "package:fintracker/helpers/migrations/migrations.dart";

import 'package:path_provider/path_provider.dart';
import 'package:permission_handler/permission_handler.dart';
import 'package:sqflite/sqflite.dart';

Database? database;

Future<Database> getDBInstance() async {
  if (database != null) return database!;

  final dbPath = join(await getDatabasesPath(), 'fintracker.db');

  database = await openDatabase(
    dbPath,
    version: 1,
    onCreate: onCreate,
    onUpgrade: onUpgrade,
  );

  return database!;
}


typedef MigrationCallback = Function(Database database);
List<MigrationCallback>migrations = [
  v1
];
void onCreate(Database database,  int version) async {
  for(MigrationCallback callback in migrations){
    await callback(database);
  }
}

void onUpgrade(Database database, int oldVersion, int version) async {
  for(int index = oldVersion; index < version; index++){
    MigrationCallback callback = migrations[index];
    await callback(database);
  }
}

Future<void> resetDatabase() async {
  Database database = await getDBInstance();
  database.delete("payments", where: "id>0");
  database.delete("accounts", where: "id>0");
  database.delete("categories", where: "id>0");

  await database.insert("accounts", {
    "name": "Cash",
    "icon": Icons.wallet.codePoint,
    "color": Colors.teal.value,
    "isDefault": 1
  });

  //prefill all categories
  List<Map<String, dynamic>> categories = [
    {"name": "Housing", "icon": Icons.house.codePoint},
    {"name": "Transportation", "icon": Icons.emoji_transportation.codePoint},
    {"name": "Food", "icon": Icons.restaurant.codePoint},
    {"name": "Utilities", "icon": Icons.category.codePoint},
    {"name": "Insurance", "icon": Icons.health_and_safety.codePoint},
    {"name": "Medical & Healthcare", "icon": Icons.medical_information.codePoint},
    {"name": "Saving, Investing, & Debt Payments", "icon": Icons.attach_money.codePoint},
    {"name": "Personal Spending", "icon": Icons.house.codePoint},
    {"name": "Recreation & Entertainment", "icon": Icons.tv.codePoint},
    {"name": "Miscellaneous", "icon": Icons.library_books_sharp.codePoint},
  ];

  int index = 0;
  for(Map<String, dynamic> category in categories){
    await database.insert("categories", {
      "name": category["name"],
      "icon": category["icon"],
      "color": Colors.primaries[index].value,
    });
    index++;
  }
}


Future<String> getExternalDocumentPath() async {
  // To check whether permission is given for this app or not.
  var status = await Permission.storage.status;
  if (!status.isGranted) {
    // If not we will ask for permission first
    await Permission.storage.request();
  }
  Directory directory = Directory("");
  if (Platform.isAndroid) {
    // Redirects it to download folder in android
    directory = Directory("/storage/emulated/0/Download");
  } else {
    directory = await getApplicationDocumentsDirectory();
  }

  final exPath = directory.path;
  await Directory(exPath).create(recursive: true);
  return exPath;
}
Future<dynamic> export() async {
  List<dynamic> accounts = await database!.query("accounts",);
  List<dynamic> categories = await database!.query("categories",);
  List<dynamic> payments = await database!.query("payments",);
  Map<String, dynamic> data = {};
  data["accounts"] = accounts;
  data["categories"] = categories;
  data["payments"] = payments;

  final path = await getExternalDocumentPath();
  String name = "fintracker-backup-${DateTime.now().millisecondsSinceEpoch}.json";
  File file= File('$path/$name');
  await file.writeAsString(jsonEncode(data));
  return file.path;
}


Future<void> import(String path) async {
  File file = File(path);
  Map<int, int> accountsMap = {};
  Map<int, int> categoriesMap = {};

  try{
    Map<String, dynamic> data = await jsonDecode(file.readAsStringSync());
    await database!.transaction((transaction) async{
      await transaction.delete("categories", where: "id!=0");
      await transaction.delete("accounts", where: "id!=0");
      await transaction.delete("payments", where: "id!=0");


      List<dynamic> categories = data["categories"];
      List<dynamic> accounts = data["accounts"];
      List<dynamic> payments = data["payments"];


      for(Map<String, dynamic> category in categories){
        int id0 = category["id"];
        category.remove("id");
        int id = await transaction.insert("categories", category);
        categoriesMap[id0] = id;
      }


      for(Map<String, dynamic> account in accounts){
        int id0 = account["id"];
        account.remove("id");
        int id = await transaction.insert("accounts", account);
        accountsMap[id0] = id;
      }

      for(Map<String, dynamic> payment in payments){
        payment.remove("id");
        payment["account"] = accountsMap[payment["account"]];
        payment["category"] = categoriesMap[payment["category"]];
        await transaction.insert("payments", payment);
      }
      return transaction;
    });
  } catch(err){
    rethrow;
  }
}



// --- FILE: lib/helpers/migrations/migrations.dart ---
import 'package:flutter/material.dart';
import 'package:sqflite/sqflite.dart';
double safeDouble(dynamic value){
  try{
    return double.parse(value);
  }catch(err){
    return 0;
  }
}
void v1(Database database) async {
  debugPrint("Running first migration....");
  await database.execute("CREATE TABLE payments ("
      "id INTEGER PRIMARY KEY AUTOINCREMENT,"
      "title TEXT NULL, "
      "description TEXT NULL, "
      "account INTEGER,"
      "category INTEGER,"
      "amount REAL,"
      "type TEXT,"
      "datetime DATETIME"
      ")");

  await database.execute("CREATE TABLE categories ("
      "id INTEGER PRIMARY KEY AUTOINCREMENT,"
      "name TEXT,"
      "icon INTEGER,"
      "color INTEGER,"
      "budget REAL NULL, "
      "type TEXT"
      ")");

  await database.execute("CREATE TABLE accounts ("
      "id INTEGER PRIMARY KEY AUTOINCREMENT,"
      "name TEXT,"
      "holderName TEXT NULL, "
      "accountNumber TEXT NULL, "
      "icon INTEGER,"
      "color INTEGER,"
      "isDefault INTEGER"
      ")");
}


// --- FILE: lib/main.dart ---
import 'package:fintracker/app.dart';
import 'package:fintracker/bloc/cubit/app_cubit.dart';
import 'package:fintracker/helpers/db.helper.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // هذا السطر يجب أن يبقى قبل أي شيء يستخدم قاعدة البيانات
  await getDBInstance();

  AppState appState = await AppState.getState();

  runApp(
    MultiBlocProvider(
      providers: [
        BlocProvider(create: (_) => AppCubit(appState)),
      ],
      child: const App(),
    ),
  );
}


// --- FILE: lib/model/account.model.dart ---
import 'package:flutter/material.dart';

class Account {
  int? id;
  String name;
  String holderName;
  String accountNumber;
  IconData icon;
  Color color;
  bool? isDefault;
  double? balance;
  double? income;
  double? expense;

  Account({
    this.id,
    required this.name,
    required this.holderName,
    required this.accountNumber,
    required this.icon,
    required this.color,
    this.isDefault,
    this.income,
    this.expense,
    this.balance
  });



  factory Account.fromJson(Map<String, dynamic> data) => Account(
    id: data["id"],
    name: data["name"],
    holderName: data["holderName"] ??"",
    accountNumber: data["accountNumber"]??"",
    icon: IconData(data["icon"], fontFamily: 'MaterialIcons'),
    color: Color(data["color"]),
    isDefault: data["isDefault"]==1?true:false,
    income: data["income"],
    expense: data["expense"],
    balance: data["balance"],
  );

  Map<String, dynamic> toJson() => {
    "id": id,
    "name": name,
    "holderName": holderName,
    "accountNumber": accountNumber,
    "icon": icon.codePoint,
    "color": color.value,
    "isDefault": (isDefault??false) ? 1:0
  };
}

// --- FILE: lib/model/category.model.dart ---
import 'package:flutter/material.dart';

class Category {
  int? id;
  String name;
  IconData icon;
  Color color;
  double? budget;
  double? expense;

  Category({
    this.id,
    required this.name,
    required this.icon,
    required this.color,
    this.budget,
    this.expense
  });

  factory Category.fromJson(Map<String, dynamic> data) => Category(
    id: data["id"],
    name: data["name"],
    icon: IconData(data["icon"], fontFamily: 'MaterialIcons'),
    color: Color(data["color"]),
    budget: data["budget"] ?? 0,
    expense: data["expense"] ?? 0,
  );

  Map<String, dynamic> toJson() => {
    "id": id,
    "name": name,
    "icon": icon.codePoint,
    "color": color.value,
    "budget": budget,
  };
}

// --- FILE: lib/model/payment.model.dart ---
import 'package:fintracker/model/account.model.dart';
import 'package:fintracker/model/category.model.dart';
import 'package:intl/intl.dart';

enum PaymentType {
  debit,
  credit
}
class Payment {
  int? id;
  Account account;
  Category category;
  double amount;
  PaymentType type;
  DateTime datetime;
  String title;
  String description;

  Payment({
    this.id,
    required this.account,
    required this.category,
    required this.amount,
    required this.type,
    required this.datetime,
    required this.title,
    required this.description
  });


  factory Payment.fromJson(Map<String, dynamic> data) {
    return Payment(
      id: data["id"],
      title: data["title"] ??"",
      description: data["description"]??"",
      account: Account.fromJson(data["account"]),
      category: Category.fromJson(data["category"]),
      amount: data["amount"],
      type: data["type"] == "CR" ? PaymentType.credit : PaymentType
          .debit,
      datetime: DateTime.parse(data["datetime"]),
    );
  }

  Map<String, dynamic> toJson() => {
    "id": id,
    "title": title,
    "description": description,
    "account": account.id,
    "category": category.id,
    "amount": amount,
    "datetime": DateFormat('yyyy-MM-dd kk:mm:ss').format(datetime),
    "type": type == PaymentType.credit ? "CR": "DR",
  };
}

// --- FILE: lib/screens/accounts/accounts.screen.dart ---
import 'package:events_emitter/events_emitter.dart';
import 'package:fintracker/dao/account_dao.dart';
import 'package:fintracker/events.dart';
import 'package:fintracker/model/account.model.dart';
import 'package:fintracker/theme/colors.dart';
import 'package:fintracker/widgets/currency.dart';
import 'package:fintracker/widgets/dialog/account_form.dialog.dart';
import 'package:fintracker/widgets/dialog/confirm.modal.dart';
import 'package:flutter/material.dart';

maskAccount(String value, [int lastLength = 4]){
  if(value.length <4 ) return value;
  int length = value.length - lastLength;
  String generated = "";
  if(length > 0){
    generated+= value.substring(0, length).split("").map((e) => e==" "? " ": "X").join("");
  }
  generated += value.substring(length);
  return generated;
}
class AccountsScreen extends StatefulWidget {
  const AccountsScreen({super.key});

  @override
  State<AccountsScreen> createState() => _AccountsScreenState();
}

class _AccountsScreenState extends State<AccountsScreen> {
  final AccountDao _accountDao = AccountDao();
  EventListener? _accountEventListener;
  List<Account> _accounts = [];


  void loadData() async {
    List<Account> accounts = await _accountDao.find(withSummery: true);
    setState(() {
      _accounts = accounts;
    });
  }


  @override
  void initState() {
    super.initState();
    loadData();

    _accountEventListener = globalEvent.on("account_update", (data){
      debugPrint("accounts are changed");
      loadData();
    });


  }

  @override
  void dispose() {

    _accountEventListener?.cancel();

    super.dispose();
  }
  @override
  Widget build(BuildContext context) {
    return Scaffold(
        appBar: AppBar(
          title: const Text("Accounts", style: TextStyle(fontWeight: FontWeight.w600, fontSize: 18),),
        ),
        body: ListView.builder(
            padding: const EdgeInsets.symmetric(horizontal: 15, vertical: 15),
            itemCount: _accounts.length,
            itemBuilder: (builder, index){
              Account account = _accounts[index];
              GlobalKey accKey = GlobalKey();
              return Stack(
                children: [
                  Container(
                      margin: const EdgeInsets.only(bottom: 20),
                      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 20),
                      decoration: BoxDecoration(
                          color: account.color.withOpacity(0.2),
                          borderRadius: BorderRadius.circular(18),
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            children: [
                              Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(account.holderName.isEmpty ? "---": account.holderName, style: const TextStyle(fontWeight: FontWeight.w600, fontSize: 18),),
                                  Text(account.name, style: Theme.of(context).textTheme.bodySmall,),
                                  Text(account.accountNumber.isEmpty ? "---": maskAccount(account.accountNumber), style: Theme.of(context).textTheme.bodySmall,),
                                ],
                              )
                            ],
                          ),
                          const SizedBox(height: 20,),
                          const Text.rich(
                              TextSpan(
                                  children: [
                                    TextSpan(text:"Total Balance", style: TextStyle(fontSize: 12, fontWeight: FontWeight.w600)),
                                  ]
                              )
                          ),
                          CurrencyText(account.balance??0, style:  const TextStyle(fontSize: 20, fontWeight: FontWeight.w700),),
                          const SizedBox(height: 10,),
                          Row(
                            children: [
                              Expanded(
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      const Text.rich(
                                          TextSpan(
                                              children: [
                                                //TextSpan(text: "▼", style: TextStyle(color: ThemeColors.success)),
                                                TextSpan(text:"Income", style: TextStyle(fontSize: 12, fontWeight: FontWeight.w600)),
                                              ]
                                          )
                                      ),
                                      CurrencyText(account.income??0, style:  const TextStyle(fontSize: 16, fontWeight: FontWeight.w700, color: ThemeColors.success),)
                                    ],
                                  )
                              ),
                              Expanded(
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      const Text.rich(
                                          TextSpan(
                                              children: [
                                                //TextSpan(text: "▲", style: TextStyle(color: ThemeColors.error)),
                                                TextSpan(text:"Expense", style: TextStyle(fontSize: 12, fontWeight: FontWeight.w600)),
                                              ]
                                          )
                                      ),
                                      CurrencyText(account.expense??0, style:  const TextStyle(fontSize: 16, fontWeight: FontWeight.w700, color: ThemeColors.error),)

                                    ],
                                  )
                              )
                            ],
                          )
                        ],
                      )
                  ),
                  Positioned(
                      right: 15,
                      bottom: 40,
                      child: Icon(account.icon, size: 20, color: account.color,)
                  ),

                  Positioned(
                      right: 0,
                      top: 0,
                    child:  IconButton(
                        key: accKey,
                        onPressed: (){
                          final RenderBox renderBox =
                          accKey.currentContext?.findRenderObject() as RenderBox;
                          final Size size = renderBox.size;
                          final Offset offset = renderBox.localToGlobal(Offset.zero);

                          showMenu(
                            context: context,
                            position: RelativeRect.fromLTRB(
                                offset.dx,
                                offset.dy + size.height,
                                offset.dx + size.width,
                                offset.dy + size.height
                            ),
                            items: [
                              PopupMenuItem<String>(
                                value: '1',
                                child: const Text('Edit'),
                                onTap: (){
                                  WidgetsBinding.instance.addPostFrameCallback((_) {
                                    showDialog(context: context, builder: (builder)=>AccountForm(account: account,));
                                  });
                                },
                              ),
                              PopupMenuItem<String>(
                                value: '2',
                                child: const Text('Delete', style: TextStyle(color: ThemeColors.error),),
                                onTap: (){
                                  WidgetsBinding.instance.addPostFrameCallback((_) {
                                    ConfirmModal.showConfirmDialog(
                                        context,
                                        title: "Are you sure?",
                                        content: const Text("All the paymentswill be deleted belongs to this account"),
                                        onConfirm: () async {
                                          Navigator.pop(context);
                                          await _accountDao.delete(account.id!);
                                          globalEvent.emit("account_update");
                                        },
                                        onCancel: (){
                                          Navigator.pop(context);
                                        }
                                    );
                                  });
                                },
                              ),
                            ],
                          );
                        },
                        icon: const Icon(Icons.more_vert, size: 20,),
                    ),
                  )
                ],
              );
            }
        ),
        floatingActionButton: FloatingActionButton(
          onPressed: (){
            showDialog(context: context, builder: (builder)=>const AccountForm());
          },
          child: const Icon(Icons.add),
        )
    );
  }
}


// --- FILE: lib/screens/categories/categories.screen.dart ---
import 'package:events_emitter/events_emitter.dart';
import 'package:fintracker/dao/category_dao.dart';
import 'package:fintracker/events.dart';
import 'package:fintracker/model/category.model.dart';
import 'package:fintracker/widgets/dialog/category_form.dialog.dart';
import 'package:flutter/material.dart';


class CategoriesScreen extends StatefulWidget {
  const CategoriesScreen({super.key});

  @override
  State<CategoriesScreen> createState() => _CategoriesScreenState();
}

class _CategoriesScreenState extends State<CategoriesScreen> {
  final CategoryDao _categoryDao = CategoryDao();
  EventListener? _categoryEventListener;
  List<Category> _categories = [];


  void loadData() async {
    List<Category> categories = await _categoryDao.find();
    setState(() {
      _categories = categories;
    });
  }


  @override
  void initState() {
    super.initState();
    loadData();

    _categoryEventListener = globalEvent.on("category_update", (data){
      debugPrint("categories are changed");
      loadData();
    });


  }

  @override
  void dispose() {

    _categoryEventListener?.cancel();

    super.dispose();
  }
  @override
  Widget build(BuildContext context) {
    return Scaffold(
        appBar: AppBar(
          title: const Text("Categories", style: TextStyle(fontWeight: FontWeight.w600, fontSize: 18),),
        ),
        body: ListView.separated(
          itemCount: _categories.length,
          itemBuilder: (builder, index){
            Category category = _categories[index];
            double expenseProgress = (category.expense??0)/(category.budget??0);
            return ListTile(
              onTap: (){
                showDialog(context: context, builder: (builder)=>CategoryForm(category: category,));
              },
              leading: CircleAvatar(backgroundColor: category.color.withOpacity(0.2),child: Icon(category.icon, color: category.color,),),
              title: Text(category.name, overflow: TextOverflow.ellipsis,style: Theme.of(context).textTheme.bodyMedium?.merge(const TextStyle(fontWeight: FontWeight.w500, fontSize: 15)),),
              subtitle: expenseProgress.isFinite? ClipRRect(
                borderRadius: BorderRadius.circular(8),
                child: LinearProgressIndicator(value: expenseProgress, semanticsLabel: expenseProgress.toString(),),
              ):Text("No budget", style: Theme.of(context).textTheme.bodySmall?.apply(color: Colors.grey, overflow: TextOverflow.ellipsis)),
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(25)),
            );
          },
          separatorBuilder: (BuildContext context, int index){
            return Container(
              width: double.infinity,
              color: Colors.grey.withAlpha(25),
              height: 1,
              margin: const EdgeInsets.only(left: 75, right: 20),
            );
          },
        ),
        floatingActionButton: FloatingActionButton(
          onPressed: (){
            showDialog(context: context, builder: (builder)=>const CategoryForm());
          },
          child: const Icon(Icons.add),
        )
    );
  }
}


// --- FILE: lib/screens/home/home.screen.dart ---
import 'package:events_emitter/events_emitter.dart';
import 'package:fintracker/bloc/cubit/app_cubit.dart';
import 'package:fintracker/dao/account_dao.dart';
import 'package:fintracker/dao/payment_dao.dart';
import 'package:fintracker/events.dart';
import 'package:fintracker/model/account.model.dart';
import 'package:fintracker/model/category.model.dart';
import 'package:fintracker/model/payment.model.dart';
import 'package:fintracker/screens/home/widgets/account_slider.dart';
import 'package:fintracker/screens/home/widgets/payment_list_item.dart';
import 'package:fintracker/screens/payment_form.screen.dart';
import 'package:fintracker/theme/colors.dart';
import 'package:fintracker/widgets/currency.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:intl/intl.dart';


String greeting() {
  var hour = DateTime.now().hour;
  if (hour < 12) {
    return 'Morning';
  }
  if (hour < 17) {
    return 'Afternoon';
  }
  return 'Evening';
}


class HomeScreen extends StatefulWidget {
  const HomeScreen({super.key});

  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  final PaymentDao _paymentDao = PaymentDao();
  final AccountDao _accountDao = AccountDao();
  EventListener? _accountEventListener;
  EventListener? _categoryEventListener;
  EventListener? _paymentEventListener;
  List<Payment> _payments = [];
  List<Account> _accounts = [];
  double _income = 0;
  double _expense = 0;
  //double _savings = 0;
  DateTimeRange _range = DateTimeRange(
      start: DateTime.now().subtract(Duration(days: DateTime.now().day -1)),
      end: DateTime.now()
  );
  Account? _account;
  Category? _category;

  void openAddPaymentPage(PaymentType type) async {
    Navigator.of(context).push(MaterialPageRoute(builder: (builder)=>PaymentForm(type: type)));
  }

  void handleChooseDateRange() async{
    final selected = await showDateRangePicker(
      context: context,
      initialDateRange: _range,
      firstDate: DateTime(2019),
      lastDate: DateTime.now(),
    );
    if(selected != null) {
      setState(() {
        _range = selected;
        _fetchTransactions();
      });
    }
  }

  void _fetchTransactions() async {
    List<Payment> trans = await _paymentDao.find(range: _range, category: _category, account:_account);
    double income = 0;
    double expense = 0;
    for (var payment in trans) {
      if(payment.type == PaymentType.credit) income += payment.amount;
      if(payment.type == PaymentType.debit) expense += payment.amount;
    }

    //fetch accounts
    List<Account> accounts = await _accountDao.find(withSummery: true);

    setState(() {
      _payments = trans;
      _income = income;
      _expense = expense;
      _accounts = accounts;
    });
  }


  @override
  void initState() {
    super.initState();
    _fetchTransactions();

    _accountEventListener = globalEvent.on("account_update", (data){
      debugPrint("accounts are changed");
      _fetchTransactions();
    });

    _categoryEventListener = globalEvent.on("category_update", (data){
      debugPrint("categories are changed");
      _fetchTransactions();
    });

    _paymentEventListener = globalEvent.on("payment_update", (data){
      debugPrint("payments are changed");
      _fetchTransactions();
    });
  }

  @override
  void dispose() {
    _accountEventListener?.cancel();
    _categoryEventListener?.cancel();
    _paymentEventListener?.cancel();
    super.dispose();
  }
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      // appBar: AppBar(
      //   leading: IconButton(
      //     icon: const Icon(Icons.menu),
      //     onPressed: (){
      //       Scaffold.of(context).openDrawer();
      //     },
      //   ),
      //   title: const Text("Home", style: TextStyle(fontWeight: FontWeight.w600, fontSize: 18),),
      // ),
      body: SingleChildScrollView(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Container(
                margin: const EdgeInsets.only(left: 15, right: 15, bottom: 15, top: 60),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text("Hi! Good ${greeting()}"),
                    BlocConsumer<AppCubit, AppState>(
                        listener: (context, state){

                        },
                        builder: (context, state)=>Text(state.username ?? "Guest", style: const TextStyle(fontSize: 18, fontWeight: FontWeight.w600),)
                    )
                  ],
                ),
              ),
              AccountsSlider(accounts: _accounts,),
              const SizedBox(height: 15,),
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 15),
                child: Row(
                    children: [
                      const Text("Payments", style: TextStyle(fontWeight: FontWeight.w600, fontSize: 17)),
                      const Expanded(child: SizedBox()),
                      MaterialButton(
                        onPressed: (){
                          handleChooseDateRange();
                        },
                        height: double.minPositive,
                        padding: EdgeInsets.zero,
                        materialTapTargetSize: MaterialTapTargetSize.shrinkWrap,
                        child: Row(
                          children: [
                            Text("${DateFormat("dd MMM").format(_range.start)} - ${DateFormat("dd MMM").format(_range.end)}", style: Theme.of(context).textTheme.bodySmall,),
                            const Icon(Icons.arrow_drop_down_outlined)
                          ],
                        ),
                      ),
                    ]
                ),
              ),
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 15, vertical: 10),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  crossAxisAlignment: CrossAxisAlignment.center,
                  children: [
                    Expanded(
                        child: Container(
                            padding: const EdgeInsets.symmetric(vertical: 14, horizontal: 16),
                            decoration: BoxDecoration(
                              borderRadius: BorderRadius.circular(18),
                              color: ThemeColors.success.withOpacity(0.2),
                            ),
                            child: SizedBox(
                              width: double.infinity,
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  const Text.rich(
                                      TextSpan(
                                          children: [
                                            //TextSpan(text: "▼", style: TextStyle(color: ThemeColors.success)),
                                            TextSpan(text:"Income", style: TextStyle(fontSize: 12, fontWeight: FontWeight.w600)),
                                          ]
                                      )
                                  ),
                                  const SizedBox(height: 5,),
                                  CurrencyText(_income, style:  const TextStyle(fontSize: 16, fontWeight: FontWeight.w700, color: ThemeColors.success),)
                                ],
                              ),
                            )
                        )
                    ),
                    const SizedBox(width: 10,),
                    Expanded(
                        child: Container(
                            padding: const EdgeInsets.symmetric(vertical: 14, horizontal: 16),
                            decoration: BoxDecoration(
                              borderRadius: BorderRadius.circular(18),
                              color: ThemeColors.error.withOpacity(0.2),
                            ),
                            child: SizedBox(
                              width: double.infinity,
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  const Text.rich(
                                      TextSpan(
                                          children: [
                                            //TextSpan(text: "▲", style: TextStyle(color: ThemeColors.error)),
                                            TextSpan(text:"Expense", style: TextStyle(fontSize: 12, fontWeight: FontWeight.w600)),
                                          ]
                                      )
                                  ),
                                  const SizedBox(height: 5,),
                                  CurrencyText(_expense, style: const TextStyle(fontSize: 16, fontWeight: FontWeight.w700, color: ThemeColors.error),)
                                ],
                              ),
                            )
                        )
                    ),
                  ],
                ),
              ),
              _payments.isNotEmpty? ListView.separated(
                padding:  EdgeInsets.zero,
                physics: const NeverScrollableScrollPhysics(),
                shrinkWrap: true,
                itemBuilder: (BuildContext context, index){
                  return PaymentListItem(payment: _payments[index], onTap: (){
                    Navigator.of(context).push(MaterialPageRoute(builder: (builder)=>PaymentForm(type: _payments[index].type, payment: _payments[index],)));
                  });

                },
                separatorBuilder: (BuildContext context, int index){
                  return Container(
                    width: double.infinity,
                    color: Colors.grey.withAlpha(25),
                    height: 1,
                    margin: const EdgeInsets.only(left: 75, right: 20),
                  );
                },
                itemCount: _payments.length,
              ):Container(
                padding: const EdgeInsets.symmetric(vertical: 25),
                alignment: Alignment.center,
                child: const Text("No payments!"),
              ),
            ],
          )
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: ()=> openAddPaymentPage(PaymentType.credit),
        child: const Icon(Icons.add),
      ),
    );
  }
}


// --- FILE: lib/screens/home/widgets/account_slider.dart ---
import 'package:fintracker/model/account.model.dart';
import 'package:fintracker/widgets/currency.dart';
import 'package:flutter/material.dart';

class AccountsSlider extends StatefulWidget{
  final List<Account> accounts;
  const AccountsSlider({super.key, required this.accounts});
  @override
  State<StatefulWidget> createState()=>_AccountSlider();
}

class _AccountSlider extends State<AccountsSlider>{
  final PageController _pageController = PageController();
  int _selected = 0;
  @override
  Widget build(BuildContext context) {
    return  Column(
      mainAxisSize: MainAxisSize.min,
      children: [
        SizedBox(
          width: double.infinity,
          height: 170,
          child: PageView.builder(
            scrollDirection: Axis.horizontal,
            itemCount: widget.accounts.length,
            controller: _pageController,
            onPageChanged: (int index){
              setState(() {
                _selected = index;
              });
            },
            itemBuilder : (BuildContext builder, int index) {
              Account account = widget.accounts[index];
              return FractionallySizedBox(
                widthFactor: 1 / _pageController.viewportFraction,
                child: Container(
                    decoration: BoxDecoration(
                      borderRadius: BorderRadius.circular(18),
                      gradient: LinearGradient(
                          begin: Alignment.centerLeft,
                          stops: const [
                            0.1,
                            0.9
                          ],
                          colors: [
                            account.color.withOpacity(0.7),
                            account.color.withOpacity(1)
                          ]
                      ),
                    ),
                    margin: const EdgeInsets.symmetric(horizontal: 15),
                    child: Stack(
                      children: [
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 20),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              CurrencyText(account.balance ?? 0, style: Theme.of(context).textTheme.headlineMedium?.merge(
                                const TextStyle(
                                    color: Colors.white,
                                    fontWeight: FontWeight.w700
                                ),
                              )),
                              Text("Balance", style: Theme.of(context).textTheme.bodyMedium?.apply(color: Colors.white.withOpacity(0.9)),),
                              const Expanded(child: SizedBox()),
                              Row(
                                crossAxisAlignment: CrossAxisAlignment.end,
                                children: [
                                  Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      Text(account.holderName, style: Theme.of(context).textTheme.bodyLarge?.apply(color: Colors.white.withOpacity(1), fontWeightDelta: 2),),
                                      Text(account.name, style: Theme.of(context).textTheme.bodySmall?.apply(color: Colors.white.withOpacity(0.5)), textAlign: TextAlign.center,),
                                    ],
                                  ),
                                  const Expanded(child:SizedBox()),
                                  Icon(account.icon, color: Colors.white)
                                ],
                              )
                            ],
                          ),
                        ),
                      ],
                    )
                ),
              );
            },
          ),
        ),
        if(widget.accounts.length > 1) const SizedBox(height: 10,),
        if(widget.accounts.length > 1) SizedBox(
          width: double.infinity,
          child: Row(
            crossAxisAlignment: CrossAxisAlignment.center,
            mainAxisAlignment: MainAxisAlignment.center,
            children: List.generate(widget.accounts.length, (index) {
              return AnimatedContainer(
                curve: Curves.ease,
                height: 6,
                duration: const Duration(milliseconds: 200),
                width: _selected == index? 20: 6,
                margin: const EdgeInsets.symmetric(horizontal: 2),
                decoration: BoxDecoration(
                    color: Colors.grey.withOpacity(_selected == index? 1:0.5),
                    borderRadius: BorderRadius.circular(60)
                ),
              );
            }),
          ),
        )
      ],
    );
  }
}



// --- FILE: lib/screens/home/widgets/payment_list_item.dart ---
import 'package:fintracker/model/payment.model.dart';
import 'package:fintracker/widgets/currency.dart';
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import '../../../theme/colors.dart';

class PaymentListItem extends StatelessWidget{
  final Payment payment;
  final VoidCallback onTap;
  const PaymentListItem({super.key, required this.payment, required this.onTap});

  @override
  Widget build(BuildContext context) {
    bool isCredit = payment.type == PaymentType.credit ;
    return ListTile(
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(25)),
      onTap: onTap,
      leading: Container(
          height: 45,
          width: 45,
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(25),
            color: payment.category.color.withOpacity(0.1),
          ),
          child:  Icon( payment.category.icon, size: 22, color: payment.category.color,)
      ),
      title: Text(payment.category.name, style: Theme.of(context).textTheme.bodyMedium?.merge(const TextStyle(fontWeight: FontWeight.w500)),),
      subtitle: Text.rich(
        TextSpan(
            children: [
              TextSpan(text: (DateFormat("dd MMM yyyy, HH:mm").format(payment.datetime))),
            ],
            style: Theme.of(context).textTheme.bodySmall?.apply(color: Colors.grey, overflow: TextOverflow.ellipsis)
        ),
      ),
      trailing: CurrencyText(
          isCredit? payment.amount : -payment.amount,
          style: Theme.of(context).textTheme.bodyMedium?.apply(color: isCredit? ThemeColors.success:ThemeColors.error)
      ),
    ) ;
  }

}

// --- FILE: lib/screens/main.screen.dart ---
import 'package:fintracker/bloc/cubit/app_cubit.dart';
import 'package:fintracker/screens/accounts/accounts.screen.dart';
import 'package:fintracker/screens/categories/categories.screen.dart';
import 'package:fintracker/screens/home/home.screen.dart';
import 'package:fintracker/screens/onboard/onboard_screen.dart';
import 'package:fintracker/screens/settings/settings.screen.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:material_symbols_icons/symbols.dart';

class MainScreen extends StatefulWidget{
  const MainScreen({super.key});
  @override
  State<MainScreen> createState() => _MainScreenState();
}

class _MainScreenState extends State<MainScreen>{
  final PageController _controller = PageController(keepPage: true);
  int _selected = 0;

  @override
  void initState() {
    super.initState();
  }
  @override
  Widget build(BuildContext context) {
    return BlocBuilder<AppCubit, AppState>(
      builder: (context, state){
        AppCubit cubit = context.read<AppCubit>();
        if(cubit.state.currency == null || cubit.state.username == null){
          return OnboardScreen();
        }
        return  Scaffold(
          body: PageView(
            controller: _controller,
            physics: const NeverScrollableScrollPhysics(),
            children: const [
              HomeScreen(),
              AccountsScreen(),
              CategoriesScreen(),
              SettingsScreen()
            ],
            onPageChanged: (int index){
              setState(() {
                _selected = index;
              });
            },
          ),
          bottomNavigationBar: NavigationBar(
            selectedIndex: _selected,
            destinations: const [
              NavigationDestination(icon: Icon(Symbols.home, fill: 1,), label: "Home"),
              NavigationDestination(icon: Icon(Symbols.wallet, fill: 1,), label: "Accounts"),
              NavigationDestination(icon: Icon(Symbols.category, fill: 1,), label: "Categories"),
              NavigationDestination(icon: Icon(Symbols.settings, fill: 1,), label: "Settings"),
            ],
            onDestinationSelected: (int selected){
                _controller.jumpToPage(selected);
            },
          ),
        );
      },
    );

  }
}

// --- FILE: lib/screens/onboard/onboard_screen.dart ---
import 'package:fintracker/screens/onboard/widgets/currency_pic.dart';
import 'package:fintracker/screens/onboard/widgets/landing.dart';
import 'package:fintracker/screens/onboard/widgets/profile.dart';
import 'package:flutter/material.dart';

class OnboardScreen extends StatelessWidget {
  OnboardScreen({super.key});
  final PageController _pageController = PageController();

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: PageView(
        controller: _pageController,
        physics: const NeverScrollableScrollPhysics(),
        children: [
          LandingPage(onGetStarted: (){
            _pageController.jumpToPage(1);
          },),
          ProfileWidget(onGetStarted: (){
            _pageController.jumpToPage(2);
          },),
          const CurrencyPicWidget()
        ],
      ),
    );
  }
}


// --- FILE: lib/screens/onboard/widgets/currency_pic.dart ---
import 'package:currency_picker/currency_picker.dart';
import 'package:fintracker/bloc/cubit/app_cubit.dart';
import 'package:fintracker/helpers/db.helper.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';

class CurrencyPicWidget extends StatefulWidget {
  const CurrencyPicWidget({super.key});

  @override
  State<StatefulWidget> createState() =>_CurrencyPicWidget();

}
class _CurrencyPicWidget extends State<CurrencyPicWidget>{
  final CurrencyService _currencyService = CurrencyService();
  String? _currency;
  String _keyword = "";

  List<Currency> filter(){
    if(_keyword.isEmpty){
      return _currencyService.getAll();
    }
    return _currencyService.getAll().where((element) => element.name.toLowerCase().contains(_keyword.toLowerCase())).toList();
  }

  @override
  void initState() {
    AppCubit cubit = context.read<AppCubit>();
    setState(() {
      _currency = cubit.state.currency;
    });
    super.initState();
  }
  @override
  Widget build(BuildContext context) {
    ThemeData theme = Theme.of(context);
    AppCubit cubit = context.read<AppCubit>();
    return Scaffold(
      body: SafeArea(
        child: Container(
          padding: const EdgeInsets.symmetric( horizontal: 15),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const SizedBox(height: 50,),
              const Icon(Icons.currency_exchange, size: 40,),
              const SizedBox(height: 15,),
              Text("Select Currency", style: theme.textTheme.headlineMedium!.apply(color: theme.colorScheme.primary, fontWeightDelta: 1),),
              const SizedBox(height: 25,),
              TextFormField(
                onChanged: (text){
                  setState(() {
                    _keyword = text;
                  });
                },
                decoration: InputDecoration(
                  filled: true,
                  border: OutlineInputBorder(borderRadius: BorderRadius.circular(18)),
                  prefixIcon: const Icon(Icons.search),
                  hintText: "Search",
                ),
              ),
              const SizedBox(height: 25,),
              Expanded(
                  child: SingleChildScrollView(
                    child: Wrap(
                      spacing: 10,
                      runSpacing: 10,
                      children: List.generate(filter().length, (index){
                        Currency currency = filter()[index];
                        return SizedBox(
                            width: (MediaQuery.of(context).size.width /2) -  20,
                            child: MaterialButton(
                                color: Theme.of(context).colorScheme.primary.withOpacity(0.1),
                                shape: RoundedRectangleBorder(
                                    borderRadius: BorderRadius.circular(18),
                                    side: BorderSide(
                                        width: 1.5,
                                        color: _currency == currency.code?  theme.colorScheme.primary : Colors.transparent
                                    )
                                ),
                                padding: const EdgeInsets.symmetric(horizontal: 25, vertical: 20),
                                elevation: 0,
                                focusElevation: 0,
                                hoverElevation: 0,
                                highlightElevation: 0,
                                disabledElevation: 0,
                                onPressed: (){
                                  setState(() {
                                    _currency = currency.code;
                                  });
                                },
                                child:  SizedBox(
                                    width: double.infinity,
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      mainAxisSize: MainAxisSize.min,
                                      children: [
                                        CircleAvatar(
                                          backgroundColor: Theme.of(context).colorScheme.primary.withOpacity(0.3),
                                          child: Text(currency.symbol),
                                        ),
                                        const SizedBox(height: 10,),
                                        Text(currency.name, style: Theme.of(context).textTheme.bodyMedium?.apply(fontWeightDelta: 2), overflow: TextOverflow.ellipsis,),
                                        Text(currency.code, style: Theme.of(context).textTheme.bodySmall, overflow: TextOverflow.ellipsis,),
                                      ],
                                    )
                                )
                            )
                        );
                      }),
                    ),
                  )
              )
            ],
          ),
        ),
      ),
      floatingActionButton: FloatingActionButton.extended(
        onPressed: (){
          if(_currency == null) {
            ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Please select currency")));
          } else {
            cubit.updateCurrency(_currency);
            resetDatabase();
          }
        },
        label: const Row(
          children: <Widget>[Text("Next"), SizedBox(width: 10,), Icon(Icons.arrow_forward)],
        ),
      ),
    );
  }

}

// --- FILE: lib/screens/onboard/widgets/landing.dart ---
import 'package:fintracker/helpers/color.helper.dart';
import 'package:fintracker/widgets/buttons/button.dart';
import 'package:flutter/material.dart';

class LandingPage extends StatelessWidget{
  final VoidCallback onGetStarted;
  const LandingPage({super.key, required this.onGetStarted});

  @override
  Widget build(BuildContext context) {
    ThemeData theme = Theme.of(context);
    return Scaffold(
      body: SafeArea(
        child: Container(
          padding: const EdgeInsets.symmetric(vertical: 30, horizontal: 15),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text("Fintracker", style: theme.textTheme.headlineLarge!.apply(color: theme.colorScheme.primary, fontWeightDelta: 1),),
              const SizedBox(height: 15,),
              Text("Easy method to manage your savings", style: theme.textTheme.headlineMedium!.apply(color: ColorHelper.lighten(theme.colorScheme.primary, 0.1)),),
              const SizedBox(height: 25,),
               Row(
                mainAxisSize: MainAxisSize.max,
                children: [
                  Icon(Icons.check_circle, color: theme.colorScheme.primary,),
                  const SizedBox(width: 15,),
                  const Expanded(child: Text("Using our app, manage your finances."))
                ],
              ),
              const SizedBox(height: 10,),
              Row(
                mainAxisSize: MainAxisSize.max,
                children: [
                  Icon(Icons.check_circle, color: theme.colorScheme.primary,),
                  const SizedBox(width: 15,),
                  const Expanded(child: Text("Simple expense monitoring for more accurate budgeting"))
                ],
              ),
              const SizedBox(height: 10,),
               Row(
                mainAxisSize: MainAxisSize.max,
                children: [
                  Icon(Icons.check_circle, color: theme.colorScheme.primary,),
                  const SizedBox(width: 15,),
                  const Expanded(child: Text("Keep track of your spending whenever and wherever you are.") ,)
                ],
              ),
              const Expanded(child: SizedBox()),
              const Text("*Since this application is currently in beta, be prepared for UI changes and unexpected behaviours."),
              const SizedBox(height: 20,),
              Container(
                alignment: Alignment.bottomRight,
                child: AppButton(
                  color: theme.colorScheme.inversePrimary,
                  isFullWidth: true,
                  onPressed: onGetStarted,
                  size: AppButtonSize.large,
                  label: "Get Started",
                  labelStyle: const TextStyle(fontWeight: FontWeight.bold),
                ),
              )

            ],
          ),
        ),
      ),
    );
  }

}

// --- FILE: lib/screens/onboard/widgets/profile.dart ---
import 'package:fintracker/bloc/cubit/app_cubit.dart';
import 'package:fintracker/helpers/color.helper.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';

class ProfileWidget extends StatelessWidget{
  final VoidCallback onGetStarted;
  const ProfileWidget({super.key, required this.onGetStarted});


  @override
  Widget build(BuildContext context) {
    ThemeData theme = Theme.of(context);
    AppCubit cubit = context.read<AppCubit>();
    TextEditingController controller = TextEditingController(text: cubit.state.username);
    return Scaffold(
      body: SafeArea(
        child: Container(
          padding: const EdgeInsets.symmetric(vertical: 50, horizontal: 25),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Icon(Icons.account_balance_wallet, size: 70,),
              const SizedBox(height: 25,),
              Text("Hi! welcome to Fintracker", style: theme.textTheme.headlineMedium!.apply(color: theme.colorScheme.primary, fontWeightDelta: 1),),
              const SizedBox(height: 15,),
              Text("What should we call you?", style: theme.textTheme.bodyLarge!.apply(color: ColorHelper.darken(theme.textTheme.bodyLarge!.color!), fontWeightDelta: 1),),
              const SizedBox(height: 25,),
              TextFormField(
                controller: controller,
                decoration: InputDecoration(
                  filled: true,
                  border: OutlineInputBorder(borderRadius: BorderRadius.circular(18)),
                  prefixIcon: const Icon(Icons.account_circle),
                  hintText: "Enter your name",
                  label: const Text("Name")
                ),
              ),
            ],
          ),
        ),
      ),
      floatingActionButton: FloatingActionButton.extended(
        onPressed: (){
          if(controller.text.isEmpty){
            ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Please enter your name")));
          } else {
            cubit.updateUsername(controller.text).then((value){
              onGetStarted();
            });
          }
        },
        label: const Row(
          children: <Widget>[Text("Next"), SizedBox(width: 10,), Icon(Icons.arrow_forward)],
        ),
      ),
    );
  }

}

// --- FILE: lib/screens/payment_form.screen.dart ---
import 'package:events_emitter/listener.dart';
import 'package:fintracker/dao/account_dao.dart';
import 'package:fintracker/dao/category_dao.dart';
import 'package:fintracker/dao/payment_dao.dart';
import 'package:fintracker/events.dart';
import 'package:fintracker/model/account.model.dart';
import 'package:fintracker/model/category.model.dart';
import 'package:fintracker/model/payment.model.dart';
import 'package:fintracker/theme/colors.dart';
import 'package:fintracker/widgets/currency.dart';
import 'package:fintracker/widgets/dialog/account_form.dialog.dart';
import 'package:fintracker/widgets/dialog/category_form.dialog.dart';
import 'package:fintracker/widgets/buttons/button.dart';
import 'package:fintracker/widgets/dialog/confirm.modal.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:intl/intl.dart';

typedef OnCloseCallback = Function(Payment payment);
final DateFormat formatter = DateFormat('dd/MM/yyyy hh:mm a');
class PaymentForm extends StatefulWidget{
  final PaymentType  type;
  final Payment?  payment;
  final OnCloseCallback? onClose;

  const PaymentForm({super.key, required this.type, this.payment, this.onClose});

  @override
  State<PaymentForm> createState() => _PaymentForm();
}

class _PaymentForm extends State<PaymentForm>{
  bool _initialised = false;
  final PaymentDao _paymentDao = PaymentDao();
  final AccountDao _accountDao = AccountDao();
  final CategoryDao _categoryDao = CategoryDao();

  EventListener? _accountEventListener;
  EventListener? _categoryEventListener;

  List<Account> _accounts = [];
  List<Category> _categories = [];

  //values
  int? _id;
  String _title = "";
  String _description="";
  Account? _account;
  Category? _category;
  double _amount=0;
  PaymentType _type= PaymentType.credit;
  DateTime _datetime = DateTime.now();

  loadAccounts(){
    _accountDao.find().then((value){
      setState(() {
        _accounts = value;
      });
    });
  }

  loadCategories(){
    _categoryDao.find().then((value){
      setState(() {
        _categories = value;
      });
    });
  }

  void populateState() async{
    await loadAccounts();
    await loadCategories();
    if(widget.payment != null) {
      setState(() {
        _id = widget.payment!.id;
        _title = widget.payment!.title;
        _description = widget.payment!.description;
        _account = widget.payment!.account;
        _category = widget.payment!.category;
        _amount = widget.payment!.amount;
        _type = widget.payment!.type;
        _datetime = widget.payment!.datetime;
        _initialised = true;
      });
    }
    else
    {
      setState(() {
        _type =  widget.type;
        _initialised = true;
      });
    }

  }

  Future<void> chooseDate(BuildContext context) async {
    DateTime initialDate = _datetime;
    final DateTime? picked = await showDatePicker(
        context: context,
        initialDate: initialDate,
        firstDate: DateTime(2000),
        lastDate: DateTime.now()
    );
    if(picked!=null  && initialDate != picked) {
      setState(() {
        _datetime = DateTime(
            picked.year,
            picked.month,
            picked.day,
            initialDate.hour,
            initialDate.minute
        );
      });
    }
  }

  Future<void> chooseTime(BuildContext context) async {
    DateTime initialDate = _datetime;
    TimeOfDay initialTime = TimeOfDay(hour: initialDate.hour, minute: initialDate.minute);
    final TimeOfDay? time = await showTimePicker(
        context: context,
        initialTime: initialTime,
        initialEntryMode: TimePickerEntryMode.input
    );
    if (time != null && initialTime !=time) {
      setState(() {
        _datetime = DateTime(
            initialDate.year,
            initialDate.month,
            initialDate.day,
            time.hour,
            time.minute
        );
      });
    }
  }

  void handleSaveTransaction(context) async{
    Payment payment = Payment(id: _id,
        account: _account!,
        category: _category!,
        amount: _amount,
        type: _type,
        datetime: _datetime,
        title: _title,
        description: _description
    );
    await _paymentDao.upsert(payment);
    if (widget.onClose != null) {
      widget.onClose!(payment);
    }
    Navigator.of(context).pop();
    globalEvent.emit("payment_update");
  }


  @override
  void initState()  {
    super.initState();
    populateState();
    _accountEventListener = globalEvent.on("account_update", (data){
      debugPrint("accounts are changed");
      loadAccounts();
    });

    _categoryEventListener = globalEvent.on("category_update", (data){
      debugPrint("categories are changed");
      loadCategories();
    });
  }

  @override
  void dispose() {

    _accountEventListener?.cancel();
    _categoryEventListener?.cancel();

    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    if(!_initialised) return const CircularProgressIndicator();

    return
      Scaffold(
          appBar: AppBar(
            title: Text("${widget.payment ==null? "New": "Edit"} Transaction", style: const TextStyle(fontWeight: FontWeight.w600, fontSize: 18),),
            actions: [
              _id!=null ? IconButton(
                  onPressed: (){
                    ConfirmModal.showConfirmDialog(context, title: "Are you sure?", content: const Text("After deleting payment can't be recovered."),
                        onConfirm: (){
                          _paymentDao.deleteTransaction(_id!).then((value) {
                            globalEvent.emit("payment_update");
                            Navigator.pop(context);
                            Navigator.pop(context);
                          });
                        },
                        onCancel: (){
                          Navigator.pop(context);
                        }
                    );

                  }, icon: const Icon(Icons.delete, size: 20,), color: ThemeColors.error
              ) : const SizedBox()
            ],
          ),
          body: Column(
            children: [
              Expanded(
                  child:SingleChildScrollView(
                      child: Container(
                        padding: const EdgeInsets.symmetric(vertical: 25,),
                        child: Column(
                          mainAxisAlignment: MainAxisAlignment.start,
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Container(
                                padding: const EdgeInsets.only(left: 15, right: 15, bottom:20),
                                child: Wrap(
                                  spacing: 10,
                                  children: [
                                    AppButton(
                                      onPressed: (){
                                        setState(() {
                                          _type = PaymentType.credit;
                                        });
                                      },
                                      label: "Income",
                                      color: Theme.of(context).colorScheme.primary,
                                      type: _type == PaymentType.credit? AppButtonType.filled: AppButtonType.outlined,
                                      borderRadius: BorderRadius.circular(45),
                                    ),

                                    AppButton(
                                      onPressed: (){
                                        setState(() {
                                          _type = PaymentType.debit;
                                        });
                                      },
                                      label: "Expense",
                                      color: Theme.of(context).colorScheme.primary,
                                      type: _type == PaymentType.debit? AppButtonType.filled: AppButtonType.outlined,
                                      borderRadius: BorderRadius.circular(45),
                                    )
                                  ],
                                )
                            ),

                            Container(
                              margin: const EdgeInsets.only(left: 15, right: 15, bottom:25),
                              child: TextFormField(
                                decoration:  InputDecoration(
                                    filled: true,
                                    hintText: "Title",
                                    border: OutlineInputBorder(borderRadius: BorderRadius.circular(15),),
                                    contentPadding: const EdgeInsets.symmetric(vertical: 14, horizontal: 15)
                                ),
                                initialValue: _title,
                                onChanged: (text){
                                  setState(() {
                                    _title = text;
                                  });
                                },
                              ),
                            ),

                            Container(
                              margin: const EdgeInsets.only(left: 15, right: 15, bottom:25),
                              child: TextFormField(
                                maxLines: null,
                                decoration: InputDecoration(
                                    filled: true,
                                    hintText: "Description",
                                    border: OutlineInputBorder(borderRadius: BorderRadius.circular(15)),
                                    contentPadding: const EdgeInsets.symmetric(vertical: 14, horizontal: 15)
                                ),
                                initialValue: _description,
                                onChanged: (text){
                                  setState(() {
                                    _description = text;
                                  });
                                },
                              ),
                            ),
                            Container(
                                margin: const EdgeInsets.only(left: 15, right: 15, bottom:25),
                                child: TextFormField(
                                  keyboardType: TextInputType.number,
                                  inputFormatters: <TextInputFormatter>[
                                    FilteringTextInputFormatter.allow(RegExp(r'^\d+\.?\d{0,4}')),
                                  ],
                                  decoration: InputDecoration(
                                      filled: true,
                                      hintText: "0.0",
                                      prefixIcon: Padding(padding: const EdgeInsets.only(left: 15), child: CurrencyText(null)),
                                      prefixIconConstraints: const BoxConstraints(minWidth: 0, minHeight: 0),
                                      border: OutlineInputBorder(borderRadius: BorderRadius.circular(15)),
                                      contentPadding: const EdgeInsets.symmetric(vertical: 14, horizontal: 15)
                                  ),
                                  initialValue: _amount == 0 ? "" : _amount.toString(),
                                  onChanged: (String text){
                                    setState(() {
                                      _amount = double.parse(text==""? "0":text);
                                    });
                                  },
                                )
                            ),

                            Container(
                                margin: const EdgeInsets.only(left: 15, right: 15, bottom:25),
                                child:   Row(
                                  mainAxisAlignment: MainAxisAlignment.center,
                                  children: [
                                    Expanded(
                                        child: InkWell(
                                            onTap: (){
                                              chooseDate(context);
                                            },
                                            child:Wrap(
                                              spacing: 10,
                                              children: [
                                                Icon(Icons.calendar_today, size: 18, color: Theme.of(context).colorScheme.primary,),
                                                Text(DateFormat("dd/MM/yyyy").format(_datetime))
                                              ],
                                            )
                                        )
                                    ),

                                    Expanded(
                                        child: InkWell(
                                            onTap: (){
                                              chooseTime(context);
                                            },
                                            child:Wrap(
                                              spacing: 10,
                                              children: [
                                                Icon(Icons.watch_later_outlined, size: 18, color: Theme.of(context).colorScheme.primary,),
                                                Text(DateFormat("hh:mm a").format(_datetime))
                                              ],
                                            )
                                        )
                                    ),
                                  ],
                                )
                            ),

                            Container(
                              padding: const EdgeInsets.only(left: 15, bottom: 15),
                              child: const Text("Select Account", style: TextStyle(fontWeight: FontWeight.w600, fontSize: 16),),
                            ),
                            Container(
                              height: 70,
                              margin: const EdgeInsets.only(bottom: 25),
                              width: double.infinity,
                              child: ListView(
                                scrollDirection: Axis.horizontal,
                                padding: const EdgeInsets.only(left: 10, right: 10,),
                                children:List.generate(_accounts.length +1, (index){
                                  if(index == 0){
                                    return Container(
                                      margin: const EdgeInsets.only(right: 5, left: 5),
                                      width: 190,
                                      child: MaterialButton(
                                          minWidth: double.infinity,
                                          color: Theme.of(context).colorScheme.primary.withOpacity(0.1),
                                          shape: RoundedRectangleBorder(
                                              borderRadius: BorderRadius.circular(18),
                                              side: const BorderSide(
                                                  width: 1.5,
                                                  color: Colors.transparent
                                              )
                                          ),
                                          padding: const EdgeInsets.symmetric(horizontal: 15, vertical: 15),
                                          elevation: 0,
                                          focusElevation: 0,
                                          hoverElevation: 0,
                                          highlightElevation: 0,
                                          disabledElevation: 0,
                                          onPressed: (){
                                            showDialog(context: context, builder: (builder)=>const AccountForm());
                                          },
                                          child:  SizedBox(
                                            width: double.infinity,
                                            child: Row(
                                              children: [
                                                CircleAvatar(
                                                  backgroundColor: Theme.of(context).colorScheme.primary.withOpacity(0.3),
                                                  child: const Icon(Icons.add, color: Colors.white),
                                                ),
                                                const SizedBox(width: 10,),
                                                Column(
                                                  crossAxisAlignment: CrossAxisAlignment.start,
                                                  mainAxisSize: MainAxisSize.min,
                                                  children: [
                                                    Text("New", style: Theme.of(context).textTheme.bodyMedium?.apply(fontWeightDelta: 2)),
                                                    Text("Create account", style: Theme.of(context).textTheme.bodySmall, overflow: TextOverflow.ellipsis,),
                                                  ],
                                                )
                                              ],
                                            ),
                                          )
                                      ),
                                    );
                                  }
                                  Account account = _accounts[index-1];
                                  return Container(
                                      margin: const EdgeInsets.only(right: 5, left: 5),
                                      child: ConstrainedBox(
                                          constraints:   const BoxConstraints(minWidth: 0,),
                                          child:  IntrinsicWidth(
                                            child:MaterialButton(
                                                color: Theme.of(context).colorScheme.primary.withOpacity(0.1),
                                                shape: RoundedRectangleBorder(
                                                    borderRadius: BorderRadius.circular(18),
                                                    side: BorderSide(
                                                        width: 1.5,
                                                        color: _account?.id == account.id ? Theme.of(context).colorScheme.primary : Colors.transparent
                                                    )
                                                ),
                                                padding: const EdgeInsets.symmetric(horizontal: 15, vertical: 15),
                                                elevation: 0,
                                                focusElevation: 0,
                                                hoverElevation: 0,
                                                highlightElevation: 0,
                                                disabledElevation: 0,
                                                onPressed: (){
                                                  setState(() {
                                                    _account = account;
                                                  });
                                                },
                                                child:  SizedBox(
                                                  width: double.infinity,
                                                  child: Row(
                                                    children: [
                                                      CircleAvatar(
                                                        backgroundColor: account.color.withOpacity(0.2),
                                                        child: Icon(account.icon, color: account.color),
                                                      ),
                                                      const SizedBox(width: 10,),
                                                      Column(
                                                        crossAxisAlignment: CrossAxisAlignment.start,
                                                        mainAxisSize: MainAxisSize.min,
                                                        children: [
                                                          Visibility(visible: account.holderName.isNotEmpty,child: Text(account.holderName, style: Theme.of(context).textTheme.bodyMedium?.apply(fontWeightDelta: 2)),),
                                                          Text(account.name, style: Theme.of(context).textTheme.bodySmall, overflow: TextOverflow.ellipsis,),
                                                        ],
                                                      )

                                                    ],
                                                  ),
                                                )
                                            ),
                                          )
                                      )
                                  );
                                }),
                              ),
                            ),

                            Container(
                              padding: const EdgeInsets.only(left: 15, bottom: 15),
                              child: const Text("Select Category", style: TextStyle(fontWeight: FontWeight.w600, fontSize: 16),),
                            ),
                            Container(
                              margin: const EdgeInsets.only(bottom: 25, left: 15, right: 15),
                              width: double.infinity,
                              child: Wrap(
                                  spacing: 10,
                                  runSpacing: 10,
                                  children: List.generate(_categories.length + 1, (index){
                                    if(_categories.length == index){
                                      return ConstrainedBox(
                                          constraints:   const BoxConstraints(minWidth: 0,),
                                          child:  IntrinsicWidth(
                                            child:MaterialButton(
                                                materialTapTargetSize: MaterialTapTargetSize.shrinkWrap,
                                                color: Theme.of(context).colorScheme.primary.withOpacity(0.1),
                                                shape: RoundedRectangleBorder(
                                                    borderRadius: BorderRadius.circular(15),
                                                    side: const BorderSide(
                                                        width: 1.5,
                                                        color: Colors.transparent
                                                    )
                                                ),
                                                padding: const EdgeInsets.symmetric(horizontal: 15, vertical: 0),
                                                elevation: 0,
                                                focusElevation: 0,
                                                hoverElevation: 0,
                                                highlightElevation: 0,
                                                disabledElevation: 0,
                                                onPressed: (){
                                                  showDialog(context: context, builder: (builder)=> const CategoryForm());
                                                },
                                                child:  SizedBox(
                                                  width: double.infinity,
                                                  child: Row(
                                                    children: [
                                                      Icon(Icons.add, color: Theme.of(context).colorScheme.primary,),
                                                      const SizedBox(width: 10,),
                                                      Text("New Category", style: Theme.of(context).textTheme.bodyMedium),
                                                    ],
                                                  ),
                                                )
                                            ),
                                          )
                                      );
                                    }
                                    Category category = _categories[index];
                                    return ConstrainedBox(
                                        constraints:   const BoxConstraints(minWidth: 0,),
                                        child:  IntrinsicWidth(
                                            child:MaterialButton(
                                                color: Theme.of(context).colorScheme.primary.withOpacity(0.1),
                                                shape: RoundedRectangleBorder(
                                                    borderRadius: BorderRadius.circular(15),
                                                    side: BorderSide(
                                                        width: 1.5,
                                                        color: _category?.id == category.id ? Theme.of(context).colorScheme.primary : Colors.transparent
                                                    )
                                                ),
                                                padding: const EdgeInsets.symmetric(horizontal: 15, vertical: 0),
                                                elevation: 0,
                                                focusElevation: 0,
                                                hoverElevation: 0,
                                                highlightElevation: 0,
                                                disabledElevation: 0,
                                                materialTapTargetSize: MaterialTapTargetSize.shrinkWrap,
                                                onPressed: (){
                                                  setState(() {
                                                    _category = category;
                                                  });
                                                },
                                                onLongPress: (){
                                                  showDialog(context: context, builder: (builder)=>CategoryForm(category: category,));
                                                },
                                                child:  SizedBox(
                                                  width: double.infinity,
                                                  child: Row(
                                                    children: [
                                                      Icon(category.icon, color: category.color),
                                                      const SizedBox(width: 10,),
                                                      Text(category.name, style: Theme.of(context).textTheme.bodyMedium, overflow: TextOverflow.ellipsis,),
                                                    ],
                                                  ),
                                                )
                                            )
                                        )
                                    );

                                  })

                              ),
                            )
                          ],
                        ) ,
                      )
                  )
              ),
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 15, vertical: 10),
                child: AppButton(
                  label: "Save Transaction",
                  height: 50,
                  labelStyle: const TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
                  isFullWidth: true,
                  onPressed: _amount > 0 && _account!=null && _category!=null ? (){
                    handleSaveTransaction(context);
                  } : null,
                  color: Theme.of(context).colorScheme.primary,
                ),
              )
            ],
          )
      );
  }
}

// --- FILE: lib/screens/settings/settings.screen.dart ---
import 'package:currency_picker/currency_picker.dart';
import 'package:file_picker/file_picker.dart';
import 'package:fintracker/bloc/cubit/app_cubit.dart';
import 'package:fintracker/helpers/color.helper.dart';
import 'package:fintracker/helpers/db.helper.dart';
import 'package:fintracker/widgets/buttons/button.dart';
import 'package:fintracker/widgets/dialog/confirm.modal.dart';
import 'package:fintracker/widgets/dialog/loading_dialog.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:material_symbols_icons/material_symbols_icons.dart';
class SettingsScreen extends StatefulWidget {
  const SettingsScreen({super.key});

  @override
  State<SettingsScreen> createState() => _SettingsScreenState();
}

class _SettingsScreenState extends State<SettingsScreen> {
  @override
  void initState() {
    super.initState();
  }
  @override
  Widget build(BuildContext context) {
    ThemeData theme = Theme.of(context);
    return Scaffold(
        appBar: AppBar(
          title: const Text("Settings", style: TextStyle(fontSize: 18, fontWeight: FontWeight.w600),),
        ),
        body: ListView(
          children: [
            ListTile(
              dense: true,
              onTap: (){
                showDialog(context: context, builder: (context){
                  TextEditingController controller = TextEditingController(text: context.read<AppCubit>().state.username);
                  return AlertDialog(
                    title: const Text("Profile", style: TextStyle(fontWeight: FontWeight.w600, fontSize: 18),),
                    content: Column(
                      mainAxisSize: MainAxisSize.min,
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text("What should we call you?", style: theme.textTheme.bodyLarge!.apply(color: ColorHelper.darken(theme.textTheme.bodyLarge!.color!), fontWeightDelta: 1),),
                        const SizedBox(height: 15,),
                        TextFormField(
                          controller: controller,
                          decoration: InputDecoration(
                              label: const Text("Name"),
                              hintText: "Enter your name",
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(15),
                              ),
                              contentPadding: const EdgeInsets.symmetric(vertical: 12, horizontal: 15)
                          ),
                        )
                      ],
                    ),
                    actions: [
                      Row(
                        children: [
                          Expanded(
                              child: AppButton(
                                onPressed: (){
                                  if(controller.text.isEmpty){
                                    ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Please enter name")));
                                  } else {
                                    context.read<AppCubit>().updateUsername(controller.text);
                                    Navigator.of(context).pop();
                                  }
                                },
                                height: 45,
                                label: "Save",
                              )
                          )
                        ],
                      )
                    ],
                  );
                });
              },
              leading: const CircleAvatar(
                  child: Icon(Symbols.person)
              ),
              title:  Text('Name', style: Theme.of(context).textTheme.bodyMedium?.merge(const TextStyle(fontWeight: FontWeight.w500, fontSize: 15))),
              subtitle: BlocBuilder<AppCubit, AppState>(builder: (context, state) {
                return Text(state.username!,style: Theme.of(context).textTheme.bodySmall?.apply(color: Colors.grey, overflow: TextOverflow.ellipsis));
              }),
            ),
            ListTile(
              dense: true,
              onTap: (){
                showCurrencyPicker(context: context, onSelect: (Currency currency){
                  context.read<AppCubit>().updateCurrency(currency.code);
                });
              },
              leading: BlocBuilder<AppCubit, AppState>(builder: (context, state) {
                Currency? currency = CurrencyService().findByCode(state.currency!);
                return CircleAvatar(
                    child: Text(currency!.symbol)
                );
              }),
              title:  Text('Currency', style: Theme.of(context).textTheme.bodyMedium?.merge(const TextStyle(fontWeight: FontWeight.w500, fontSize: 15))),
              subtitle: BlocBuilder<AppCubit, AppState>(builder: (context, state) {
                Currency? currency = CurrencyService().findByCode(state.currency!);
                return Text(currency!.name, style: Theme.of(context).textTheme.bodySmall?.apply(color: Colors.grey, overflow: TextOverflow.ellipsis));
              }),
            ),
            ListTile(
              dense: true,
              onTap:() async {
                ConfirmModal.showConfirmDialog(
                    context, title: "Are you sure?",
                    content: const Text("want to export all the data to a file"),
                    onConfirm: ()async{
                      Navigator.of(context).pop();
                      LoadingModal.showLoadingDialog(context, content: const Text("Exporting data please wait"));
                      await export().then((value){
                        ScaffoldMessenger.of(context).showSnackBar( SnackBar(content: Text("File has been saved in $value")));
                      }).catchError((err){
                        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Something went wrong while exporting data")));
                      }).whenComplete((){
                        Navigator.of(context).pop();
                      });
                    },
                    onCancel: (){
                      Navigator.of(context).pop();
                    }
                );
              },
              leading: const CircleAvatar(
                  child: Icon(Symbols.download,)
              ),
              title:  Text('Export', style: Theme.of(context).textTheme.bodyMedium?.merge(const TextStyle(fontWeight: FontWeight.w500, fontSize: 15))),
              subtitle:  Text("Export to file",style: Theme.of(context).textTheme.bodySmall?.apply(color: Colors.grey, overflow: TextOverflow.ellipsis)),
             ),
            ListTile(
              dense: true,
              onTap:() async {
                await FilePicker.platform.pickFiles(
                    dialogTitle: "Pick file",
                    allowMultiple: false,
                    allowCompression: false,
                    type:FileType.custom,
                    allowedExtensions: ["json"]
                ).then((pick){
                  if(pick == null || pick.files.isEmpty) {
                    return  ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Please select file")));
                  }
                  PlatformFile file = pick.files.first;
                  ConfirmModal.showConfirmDialog(
                      context, title: "Are you sure?",
                      content: const Text("All payment data, categories, and accounts will be erased and replaced with the information imported from the backup."),
                      onConfirm: ()async{
                        Navigator.of(context).pop();
                        LoadingModal.showLoadingDialog(context, content: const Text("Exporting data please wait"));
                        await import(file.path!).then((value){
                          ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Successfully imported.")));
                          Navigator.of(context).pop();
                        }).catchError((err){
                          ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Something went wrong while importing data")));
                        });
                      },
                      onCancel: (){
                        Navigator.of(context).pop();
                      }
                  );
                }).catchError((err){
                  return ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Something went wrong while importing data")));
                });
              },
              leading: const CircleAvatar(
                  child: Icon(Symbols.upload,)
              ),
              title:  Text('Import', style: Theme.of(context).textTheme.bodyMedium?.merge(const TextStyle(fontWeight: FontWeight.w500, fontSize: 15))),
              subtitle:  Text("Import from backup file",style: Theme.of(context).textTheme.bodySmall?.apply(color: Colors.grey, overflow: TextOverflow.ellipsis)),

            ),
            // ListTile(
            //   dense: true,
            //   onTap: () async {
            //     ConfirmModal.showConfirmDialog(
            //         context, title: "Are you sure?",
            //         content: const Text("After deleting data can't be recovered"),
            //         onConfirm: ()async{
            //           Navigator.of(context).pop();
            //           Navigator.of(context).pop();
            //           await context.read<AppCubit>().reset();
            //           await resetDatabase();
            //         },
            //         onCancel: (){
            //           Navigator.of(context).pop();
            //         }
            //     );
            //   },
            //   leading: CircleAvatar(
            //       backgroundColor: ThemeColors.error.withAlpha(90),
            //       child: const Icon(Symbols.device_reset,)
            //   ),
            //   title:  Text('Reset', style: Theme.of(context).textTheme.bodyMedium?.merge(const TextStyle(fontWeight: FontWeight.w500, fontSize: 15))),
            //   subtitle:  Text("Delete all the data",style: Theme.of(context).textTheme.bodySmall?.apply(color: Colors.grey, overflow: TextOverflow.ellipsis)),
            // ),
          ],
        )
    );
  }
}


// --- FILE: lib/theme/colors.dart ---
import 'package:flutter/material.dart';

class ThemeColors{
  static const MaterialColor success = MaterialColor(_successPrimaryValue, <int, Color>{
    50: Color(0xFFE2F4EA),
    100: Color(0xFFB6E4CB),
    200: Color(0xFF85D2A9),
    300: Color(0xFF54C087),
    400: Color(0xFF2FB36D),
    500: Color(_successPrimaryValue),
    600: Color(0xFF099D4C),
    700: Color(0xFF079342),
    800: Color(0xFF058A39),
    900: Color(0xFF037929),
  });
  static const int _successPrimaryValue = 0xFF0AA553;

  static const MaterialColor successAccent = MaterialColor(_successAccentValue, <int, Color>{
    100: Color(0xFF80FF80),
    200: Color(_successAccentValue),
    400: Color(0xFF2AFF2A),
    700: Color(0xFF1AFF1A),
  });
  static const int _successAccentValue = 0xFF43FF43;

  static const MaterialColor info = MaterialColor(_infoPrimaryValue, <int, Color>{
    50: Color(0xFFE1EFFA),
    100: Color(0xFFB3D7F3),
    200: Color(0xFF81BCEB),
    300: Color(0xFF4EA1E2),
    400: Color(0xFF288CDC),
    500: Color(_infoPrimaryValue),
    600: Color(0xFF0270D1),
    700: Color(0xFF0165CC),
    800: Color(0xFF015BC6),
    900: Color(0xFF0148BC),
  });
  static const int _infoPrimaryValue = 0xFF0278D6;

  static const MaterialColor infoAccent = MaterialColor(_infoAccentValue, <int, Color>{
    100: Color(0xFF90C9FF),
    200: Color(_infoAccentValue),
    400: Color(0xFF3A9FFF),
    700: Color(0xFF2A98FF),
  });
  static const int _infoAccentValue = 0xFF53ACFF;

  static const MaterialColor warning = MaterialColor(_warningPrimaryValue, <int, Color>{
    50: Color(0xFFFDF2E0),
    100: Color(0xFFFADEB3),
    200: Color(0xFFF6C980),
    300: Color(0xFFF2B34D),
    400: Color(0xFFF0A226),
    500: Color(_warningPrimaryValue),
    600: Color(0xFFEB8A00),
    700: Color(0xFFE87F00),
    800: Color(0xFFE57500),
    900: Color(0xFFE06300),
  });
  static const int _warningPrimaryValue = 0xFFED9200;

  static const MaterialColor warningAccent = MaterialColor(_warningAccentValue, <int, Color>{
    100: Color(0xFFFFF6F4),
    200: Color(_warningAccentValue),
    400: Color(0xFFFFB19D),
    700: Color(0xFFFFA58E),
  });
  static const int _warningAccentValue = 0xFFFFC5B6;

  static const MaterialColor error = MaterialColor(_errorPrimaryValue, <int, Color>{
    50: Color(0xFFFBE6E5),
    100: Color(0xFFF6C1BF),
    200: Color(0xFFF09895),
    300: Color(0xFFE96E6A),
    400: Color(0xFFE54F4A),
    500: Color(_errorPrimaryValue),
    600: Color(0xFFDC2B25),
    700: Color(0xFFD8241F),
    800: Color(0xFFD31E19),
    900: Color(0xFFCB130F),
  });
  static const int _errorPrimaryValue = 0xFFE0302A;

  static const MaterialColor errorAccent = MaterialColor(_errorAccentValue, <int, Color>{
    100: Color(0xFFFFBFC8),
    200: Color(_errorAccentValue),
    400: Color(0xFFFF687E),
    700: Color(0xFFFF5971),
  });
  static const int _errorAccentValue = 0xFFFF8294;
  static const MaterialColor primary = MaterialColor(_primaryPrimaryValue, <int, Color>{
    50: Color(0xFFEDE3E5),
    100: Color(0xFFD2B9BF),
    200: Color(0xFFB48A95),
    300: Color(0xFF955B6A),
    400: Color(0xFF7F384A),
    500: Color(_primaryPrimaryValue),
    600: Color(0xFF601225),
    700: Color(0xFF550F1F),
    800: Color(0xFF4B0C19),
    900: Color(0xFF3A060F),
  });
  static const int _primaryPrimaryValue = 0xFF68152A;

  static const MaterialColor primaryAccent = MaterialColor(_primaryAccentValue, <int, Color>{
    100: Color(0xFFFF2484),
    200: Color(_primaryAccentValue),
    400: Color(0xFFCC005A),
    700: Color(0xFFBD0053),
  });
  static const int _primaryAccentValue = 0xFFE50065;
}

// --- FILE: lib/widgets/buttons/button.dart ---
import 'package:flutter/material.dart';

enum AppButtonType{
  outlined, filled, duoTone;
}
enum AppButtonSize{
  small,
  normal,
  large;
}

class AppButton extends StatelessWidget{
  final double? height;
  final double? width;
  final String? label;
  final IconData? icon;
  final Color? color;
  final BorderRadius? borderRadius;
  final VoidCallback? onPressed;
  final VoidCallback? onLongPress;
  final AppButtonType? type;
  final AppButtonSize? size;
  final double? iconSize;
  final TextStyle? labelStyle;
  final bool? isFullWidth;
  const AppButton({
    super.key,
    this.label,
    this.icon,
    this.color,
    this.onPressed,
    this.onLongPress,
    this.height,
    this.width,
    this.borderRadius,
    this.type = AppButtonType.filled,
    this.size = AppButtonSize.normal,
    this.iconSize,
    this.labelStyle,
    this.isFullWidth,
  });
  @override
  Widget build(BuildContext context) {
    bool isDarkMode = MediaQuery.of(context).platformBrightness == Brightness.dark;
    Color fallBackColor = color ?? (isDarkMode ? Theme.of(context).colorScheme.primary : Theme.of(context).colorScheme.primary);
    Color typoColor = Colors.transparent;
    Color backgroundColor = Colors.transparent;
    Color borderColor = Colors.transparent;
    Color splashColor = Colors.transparent;
    double borderWidth = 0;
    //for  filled button
    if(type == AppButtonType.filled){
      typoColor = Colors.white;
      backgroundColor = color ?? Theme.of(context).colorScheme.primary;
      borderColor = Colors.transparent;
      splashColor = Colors.white.withAlpha(100);
    }

    //for duoTone
    if(type == AppButtonType.duoTone){
      typoColor = fallBackColor;
      backgroundColor = (fallBackColor).withAlpha(40);
      borderColor = fallBackColor.withAlpha(10);
      splashColor = (fallBackColor).withAlpha(100);
      borderWidth = 1.5;
    }

    //for outlined button
    if(type == AppButtonType.outlined){
      typoColor = fallBackColor;
      backgroundColor = Colors.transparent;
      borderColor = fallBackColor;
      splashColor = (fallBackColor).withAlpha(20);
      borderWidth = 1.5;
    }



    //for size
    double dimension = 0;

    switch(size){
      case AppButtonSize.small: dimension = 30 ; break;
      case AppButtonSize.normal: dimension = 40 ; break;
      case AppButtonSize.large: dimension = 55 ;break;
      default: break;
    }
    dimension = height ?? dimension;


    double paddingStart = dimension*0.6;
    double paddingEnd = dimension*0.6;

    if(icon != null){
      paddingStart = dimension*0.5;
    }
    EdgeInsets padding = EdgeInsets.only(left: paddingStart, right: paddingEnd);
    if(width != null){
      padding = EdgeInsets.zero;
    }

    return
      ConstrainedBox(
          constraints:  BoxConstraints(
              minWidth: isFullWidth?? false ? double.infinity : width??dimension,
              minHeight: dimension,
              maxWidth: width ?? double.infinity
          ),
          child:  IntrinsicWidth(
              child:MaterialButton(
                color: backgroundColor,
                materialTapTargetSize: MaterialTapTargetSize.shrinkWrap,
                disabledColor: backgroundColor.withAlpha(50),
                onPressed: onPressed,
                onLongPress: onLongPress,
                minWidth: dimension,
                padding: padding,
                height: dimension,
                elevation: 0,
                focusElevation: 0,
                highlightElevation: 0,
                hoverElevation: 0,
                shape:  RoundedRectangleBorder(
                    borderRadius: borderRadius ?? BorderRadius.circular(dimension * 0.35),
                    side: BorderSide(
                        width: borderWidth,
                        color: borderColor
                    )
                ),
                splashColor: splashColor,
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  crossAxisAlignment: CrossAxisAlignment.center,
                  children: [
                    icon != null ? Icon(icon, color: typoColor, size: iconSize ?? (dimension - (dimension*(55/100))),) : const SizedBox(),
                    icon != null && label!= null ? SizedBox(width: dimension*0.3,) : const SizedBox(),
                    label!= null ?Text(label??"" ,style: TextStyle(color: typoColor).merge(labelStyle),): const SizedBox()
                  ],
                ),
              )
          )
      );
  }
}

// --- FILE: lib/widgets/currency.dart ---
import 'package:currency_picker/currency_picker.dart';
import 'package:fintracker/bloc/cubit/app_cubit.dart';
import 'package:fintracker/helpers/currency.helper.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';

class CurrencyText extends StatelessWidget{
  final double? amount;
  final TextStyle? style;
  final TextOverflow? overflow;
  final CurrencyService currencyService = CurrencyService();

  CurrencyText(this.amount, {super.key , this.style, this. overflow});

  @override
  Widget build(BuildContext context) {
    return BlocBuilder<AppCubit, AppState>(builder: (context, state){
      Currency? currency = currencyService.findByCode(state.currency!);
      return Text(amount==null? "${currency!.symbol} " : CurrencyHelper.format(amount!, name: currency?.code, symbol: currency?.symbol), style: style, overflow: overflow,);
    });
  }
}



// --- FILE: lib/widgets/dialog/account_form.dialog.dart ---
import 'package:fintracker/dao/account_dao.dart';
import 'package:fintracker/events.dart';
import 'package:fintracker/model/account.model.dart';
import 'package:fintracker/widgets/buttons/button.dart';
import 'package:flutter/material.dart';
import 'package:fintracker/data/icons.dart';
typedef Callback = void Function();

class AccountForm extends StatefulWidget {
  final Account? account;
  final Callback? onSave;

  const AccountForm({super.key, this.account, this.onSave});

  @override
  State<StatefulWidget> createState() => _AccountForm();
}
class _AccountForm extends State<AccountForm>{
  final AccountDao _accountDao = AccountDao();
  Account? _account;
  @override
  void initState() {
    super.initState();
    if(widget.account != null){
      _account = Account(
          id: widget.account!.id,
          name: widget.account!.name,
          holderName: widget.account!.holderName,
          accountNumber: widget.account!.accountNumber,
          icon: widget.account!.icon,
          color: widget.account!.color
      );
    } else {
      _account = Account(
          name: "",
          holderName: "",
          accountNumber: "",
          icon: Icons.account_circle,
          color: Colors.grey
      );
    }
  }

  void onSave (context) async{
    await _accountDao.upsert(_account!);
    if(widget.onSave != null) {
      widget.onSave!();
    }
    Navigator.pop(context);
    globalEvent.emit("account_update");
  }

  void pickIcon(context)async {

  }
  @override
  Widget build(BuildContext context) {
    if(_account == null ){
      return const CircularProgressIndicator();
    }
    return AlertDialog(
      title: Text(widget.account!=null?"Edit Account":"New Account", style: const TextStyle(fontSize: 20, fontWeight: FontWeight.w600),),
      scrollable: true,
      insetPadding: const EdgeInsets.all(20),
      content: SizedBox(
          width: MediaQuery.sizeOf(context).width,
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              const SizedBox(height: 15,),
              Row(
                crossAxisAlignment: CrossAxisAlignment.center,
                mainAxisAlignment: MainAxisAlignment.center,
                children: [

                  Container(
                    height: 50,
                    width: 50,
                    decoration: BoxDecoration(
                        color: _account!.color,
                        borderRadius: BorderRadius.circular(40)
                    ),
                    alignment: Alignment.center,
                    child: Icon(_account!.icon, color: Colors.white,),
                  ),
                  const SizedBox(width: 15,),
                  Expanded(
                      child: TextFormField(
                        initialValue: _account!.name,
                        decoration: InputDecoration(
                            labelText: 'Name',
                            hintText: 'Account name',
                            border: OutlineInputBorder(borderRadius: BorderRadius.circular(15),),
                            contentPadding: const EdgeInsets.symmetric(vertical: 12, horizontal: 15)
                        ),
                        onChanged: (String text){
                          setState(() {
                            _account!.name = text;
                          });
                        },
                      )
                  )
                ],
              ),
              Container(
                padding: const EdgeInsets.only(bottom: 20, top: 20),
                child: TextFormField(
                  decoration: InputDecoration(
                      labelText: 'Holder name',
                      hintText: 'Enter account holder name',
                      border: OutlineInputBorder(borderRadius: BorderRadius.circular(15),),
                      contentPadding: const EdgeInsets.symmetric(vertical: 12, horizontal: 15)
                  ),
                  initialValue: _account!.holderName,
                  onChanged: (text){
                    setState(() {
                      _account!.holderName = text;
                    });
                  },
                ),
              ),

              Container(
                padding: const EdgeInsets.only(bottom: 20,),
                child: TextFormField(
                  decoration: InputDecoration(
                      labelText: 'A/C Number',
                      hintText: 'Enter account number',
                      border: OutlineInputBorder(borderRadius: BorderRadius.circular(15),),
                      contentPadding: const EdgeInsets.symmetric(vertical: 12, horizontal: 15)
                  ),
                  initialValue: _account!.accountNumber,
                  onChanged: (text){
                    setState(() {
                      _account!.accountNumber = text;
                    });
                  },
                ),
              ),

              //Color picker
              SizedBox(
                height: 45,
                width: double.infinity,
                child: ListView.builder(
                    scrollDirection: Axis.horizontal,
                    itemCount: Colors.primaries.length,
                    itemBuilder: (BuildContext context, index)=>
                        Container(
                          width: 45,
                          height: 45,
                          padding: const EdgeInsets.symmetric(horizontal: 2.5, vertical: 2.5),
                          child: GestureDetector(
                              onTap: () {
                                setState(() {
                                  _account!.color = Colors.primaries[index];
                                });
                              },
                              child:  Container(
                                decoration: BoxDecoration(
                                    color: Colors.primaries[index],
                                    borderRadius: BorderRadius.circular(40),
                                    border: Border.all(
                                      width: 2,
                                      color: _account!.color.value == Colors.primaries[index].value ? Colors.white: Colors.transparent,
                                    )
                                ),
                              )
                          ),
                        )

                ),
              ),
              const SizedBox(height: 5,),

              //Icon picker
              SizedBox(
                height: 45,
                width: double.infinity,
                child: ListView.builder(
                    scrollDirection: Axis.horizontal,
                    itemCount: AppIcons.icons.length,
                    itemBuilder: (BuildContext context, index)=>Container(
                        width: 45,
                        height: 45,
                        padding: const EdgeInsets.symmetric(horizontal: 2.5, vertical: 2.5),
                        child: GestureDetector(
                            onTap: () {
                              setState(() {
                                _account!.icon = AppIcons.icons[index];
                              });
                            },
                            child:  Container(
                              height: 50,
                              width: 50,
                              decoration: BoxDecoration(
                                  color: Theme.of(context).colorScheme.primary.withOpacity(0.1),
                                  borderRadius: BorderRadius.circular(40),
                                  border: Border.all(
                                      color: _account!.icon == AppIcons.icons[index] ? Theme.of(context).colorScheme.primary: Colors.transparent,
                                      width: 2
                                  )
                              ),
                              child:Icon(AppIcons.icons[index], color: Theme.of(context).colorScheme.primary, size: 18,),
                            )
                        )
                    )

                ),
              ),
            ],
          )
      ),
      actions: [
        AppButton(
          height: 45,
          isFullWidth: true,
          onPressed: (){
            onSave(context);
          },
          color: Theme.of(context).colorScheme.primary,
          label: "Save",
        )
      ],
    );
  }

}

// --- FILE: lib/widgets/dialog/category_form.dialog.dart ---
import 'package:fintracker/dao/category_dao.dart';
import 'package:fintracker/data/icons.dart';
import 'package:fintracker/events.dart';
import 'package:fintracker/model/category.model.dart';
import 'package:fintracker/widgets/buttons/button.dart';
import 'package:fintracker/widgets/currency.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
typedef Callback = void Function();
class CategoryForm extends StatefulWidget {
  final Category? category;
  final Callback? onSave;

  const CategoryForm({super.key, this.category, this.onSave});

  @override
  State<StatefulWidget> createState() => _CategoryForm();
}
class _CategoryForm extends State<CategoryForm>{
  final CategoryDao _categoryDao = CategoryDao();
  final TextEditingController _nameController = TextEditingController();
  Category _category = Category(name: "", icon: Icons.wallet_outlined, color: Colors.pink);

  @override
  void initState() {
    super.initState();
    if(widget.category != null){
      _nameController.text = widget.category!.name;
      _category = widget.category??Category(name: "", icon: Icons.wallet_outlined, color: Colors.pink);
    }
  }

  void onSave (context) async{
    await _categoryDao.upsert(_category);
    if(widget.onSave != null) {
      widget.onSave!();
    }
    Navigator.pop(context);
    globalEvent.emit("category_update");
  }

  void pickIcon(context)async {

  }
  @override
  Widget build(BuildContext context) {
    return  AlertDialog(
      scrollable: true,
      insetPadding: const EdgeInsets.all(10),
      title: Text(widget.category!=null?"Edit Category":"New Category", style: const TextStyle(fontSize: 20, fontWeight: FontWeight.w600),),
      content: SizedBox(
        width: MediaQuery.of(context).size.width,
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            const SizedBox(height: 15,),
            Row(
              crossAxisAlignment: CrossAxisAlignment.center,
              mainAxisAlignment: MainAxisAlignment.center,
              children: [

                Container(
                  height: 50,
                  width: 50,
                  decoration: BoxDecoration(
                      color: _category.color,
                      borderRadius: BorderRadius.circular(40)
                  ),
                  alignment: Alignment.center,
                  child: Icon(_category.icon, color: Colors.white,),
                ),
                const SizedBox(width: 15,),
                Expanded(
                    child: TextFormField(
                      initialValue: _category.name,
                      decoration: InputDecoration(
                        labelText: 'Name',
                        hintText: 'Enter Category name',
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(15),
                        ),
                        contentPadding: const EdgeInsets.symmetric(vertical: 12, horizontal: 15)
                      ),
                      onChanged: (String text){
                        setState(() {
                          _category.name = text;
                        });
                      },
                    )
                )
              ],
            ),
            Container(
              padding: const EdgeInsets.only(top: 20),
              child: TextFormField(
                initialValue: _category.budget == null ?"":_category.budget.toString(),
                keyboardType: TextInputType.number,
                inputFormatters: <TextInputFormatter>[
                  FilteringTextInputFormatter.allow(RegExp(r'^\d+\.?\d{0,4}')),
                ],
                decoration: InputDecoration(
                    labelText: 'Budget',
                    hintText: 'Enter budget',
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(15),
                    ),
                    contentPadding: const EdgeInsets.symmetric(vertical: 12, horizontal: 15),
                  prefixIcon: Padding(padding: const EdgeInsets.only(left: 15), child: CurrencyText(null)),
                  prefixIconConstraints: const BoxConstraints(minWidth: 0, minHeight: 0),
                ),
                onChanged: (String text){
                  setState(() {
                    _category.budget = double.parse(text.isEmpty? "0":text);
                  });
                },
              ),
            ),
            const SizedBox(height: 20,),
            //Color picker
            SizedBox(
              height: 45,
              width: double.infinity,
              child: ListView.builder(
                  scrollDirection: Axis.horizontal,
                  itemCount: Colors.primaries.length,
                  itemBuilder: (BuildContext context, index)=>
                      Container(
                        width: 45,
                        height: 45,
                        padding: const EdgeInsets.symmetric(horizontal: 2.5, vertical: 2.5),
                        child: GestureDetector(
                            onTap: () {
                              setState(() {
                                _category.color = Colors.primaries[index];
                              });
                            },
                            child:  Container(
                              decoration: BoxDecoration(
                                  color: Colors.primaries[index],
                                  borderRadius: BorderRadius.circular(40),
                                  border: Border.all(
                                    width: 2,
                                    color: _category.color.value == Colors.primaries[index].value ? Colors.white: Colors.transparent,
                                  )
                              ),
                            )
                        ),
                      )

              ),
            ),
            const SizedBox(height: 15,),

            //Icon picker
            SizedBox(
              height: 45,
              width: double.infinity,
              child: ListView.builder(
                  scrollDirection: Axis.horizontal,
                  itemCount: AppIcons.icons.length,
                  itemBuilder: (BuildContext context, index)=>Container(
                      width: 45,
                      height: 45,
                      padding: const EdgeInsets.symmetric(horizontal: 2.5, vertical: 2.5),
                      child: GestureDetector(
                          onTap: () {
                            setState(() {
                              _category.icon = AppIcons.icons[index];
                            });
                          },
                          child:  Container(
                            height: 50,
                            width: 50,
                            decoration: BoxDecoration(
                                color: Theme.of(context).colorScheme.primary.withOpacity(0.1),
                                borderRadius: BorderRadius.circular(40),
                                border: Border.all(
                                    color: _category.icon == AppIcons.icons[index] ? Theme.of(context).colorScheme.primary: Colors.transparent,
                                    width: 2
                                )
                            ),
                            child:Icon(AppIcons.icons[index], color: Theme.of(context).colorScheme.primary, size: 18,),
                          )
                      )
                  )

              ),
            ),
          ],
        ),
      ),
      actions: [
        AppButton(
          height: 45,
          isFullWidth: true,
          onPressed: (){
            onSave(context);
          },
          color: Theme.of(context).colorScheme.primary,
          label: "Save",
        )
      ],
    );

  }

}

// --- FILE: lib/widgets/dialog/confirm.modal.dart ---
import 'package:fintracker/theme/colors.dart';
import 'package:fintracker/widgets/buttons/button.dart';
import 'package:flutter/material.dart';

class ConfirmModal extends StatelessWidget{
  final String title;
  final Widget content;
  final VoidCallback onConfirm;
  final VoidCallback onCancel;
  const ConfirmModal({
    super.key,
    required this.title,
    required this.content,
    required this.onConfirm,
    required this.onCancel
  });
  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: Text(title, style: const TextStyle(fontWeight: FontWeight.w600),),
      insetPadding: const EdgeInsets.all(20),
      content: content,
      actions: [
        Row(
          children: [
            Expanded(
                child: AppButton(
                    label: "No",
                    onPressed: onCancel,
                    color: Theme.of(context).colorScheme.primary,
                    type: AppButtonType.outlined
                )
            ),
            const SizedBox(width: 15,),
            Expanded(
                child: AppButton(
                  label: "Yes",
                  onPressed: onConfirm,
                  color: ThemeColors.error,
                )
            ),
          ],
        )
      ],
    );
  }

  static showConfirmDialog(BuildContext context, {
    required String title,
    required Widget content,
    required VoidCallback onConfirm,
    required VoidCallback onCancel
  }
  ){
    showDialog(context: context, builder: (BuildContext context){
      return ConfirmModal(title: title, content: content, onConfirm: onConfirm, onCancel: onCancel);
    });
  }

}

// --- FILE: lib/widgets/dialog/loading_dialog.dart ---
import 'package:flutter/material.dart';

class LoadingModal extends StatelessWidget{
  final Widget content;
  const LoadingModal({
    super.key,
    required this.content,
  });
  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      insetPadding: const EdgeInsets.all(20),
      content: Row(
        crossAxisAlignment: CrossAxisAlignment.center,
        children: [
          const CircularProgressIndicator(),
          const SizedBox(width: 20,),
          Expanded(child: content)
        ],
      )
    );
  }

  static showLoadingDialog(BuildContext context, {
    required Widget content,
  }){
    showDialog(context: context,
        builder: (BuildContext context){
          return LoadingModal(content: content);
        }
    );
  }

}
